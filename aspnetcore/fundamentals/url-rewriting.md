---
title: ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core
author: rick-anderson
description: Сведения о переопределении и перенаправлении URL-адресов с помощью ПО промежуточного слоя для переопределения URL-адресов в приложениях ASP.NET Core.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 08/16/2019
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: fundamentals/url-rewriting
ms.openlocfilehash: 44e6570090de9c5f3550d18a30fcde758fb16f85
ms.sourcegitcommit: 54fe1ae5e7d068e27376d562183ef9ddc7afc432
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/10/2021
ms.locfileid: "102588527"
---
# <a name="url-rewriting-middleware-in-aspnet-core"></a><span data-ttu-id="a8608-103">ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="a8608-103">URL Rewriting Middleware in ASP.NET Core</span></span>

<span data-ttu-id="a8608-104">Авторы: [Микаэль Менгисту](https://github.com/mikaelm12) (Mikael Mengistu)</span><span class="sxs-lookup"><span data-stu-id="a8608-104">By [Mikael Mengistu](https://github.com/mikaelm12)</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="a8608-105">Этот документ содержит вводные сведения о переопределении URL-адресов и инструкции по использованию ПО промежуточного слоя для переопределения URL-адресов в приложениях ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a8608-105">This document introduces URL rewriting with instructions on how to use URL Rewriting Middleware in ASP.NET Core apps.</span></span>

<span data-ttu-id="a8608-106">Переопределение URL-адресов представляет собой изменение URL-адресов запросов на основе одного или нескольких предопределенных правил.</span><span class="sxs-lookup"><span data-stu-id="a8608-106">URL rewriting is the act of modifying request URLs based on one or more predefined rules.</span></span> <span data-ttu-id="a8608-107">Переопределение URL-адресов создает абстракцию между расположениями ресурсов и их адресами, позволяя убрать тесную связь между ними.</span><span class="sxs-lookup"><span data-stu-id="a8608-107">URL rewriting creates an abstraction between resource locations and their addresses so that the locations and addresses aren't tightly linked.</span></span> <span data-ttu-id="a8608-108">Существует несколько сценариев, где может пригодиться переопределение URL-адресов:</span><span class="sxs-lookup"><span data-stu-id="a8608-108">URL rewriting is valuable in several scenarios to:</span></span>

* <span data-ttu-id="a8608-109">Временное или постоянное перемещение или замещение ресурсов сервера с сохранением стабильных указателей для этих ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a8608-109">Move or replace server resources temporarily or permanently and maintain stable locators for those resources.</span></span>
* <span data-ttu-id="a8608-110">Разделение обработки запросов между разными приложениями или разными областями одного приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-110">Split request processing across different apps or across areas of one app.</span></span>
* <span data-ttu-id="a8608-111">Удаление, добавление или переупорядочение сегментов URL-адресов для входящих запросов.</span><span class="sxs-lookup"><span data-stu-id="a8608-111">Remove, add, or reorganize URL segments on incoming requests.</span></span>
* <span data-ttu-id="a8608-112">Оптимизация общедоступных URL-адресов в целях оптимизации для поисковых систем (SEO).</span><span class="sxs-lookup"><span data-stu-id="a8608-112">Optimize public URLs for Search Engine Optimization (SEO).</span></span>
* <span data-ttu-id="a8608-113">Разрешение использования понятных общедоступных URL-адресов, чтобы помочь посетителям прогнозировать содержимое, возвращаемое в результате запроса ресурса.</span><span class="sxs-lookup"><span data-stu-id="a8608-113">Permit the use of friendly public URLs to help visitors predict the content returned by requesting a resource.</span></span>
* <span data-ttu-id="a8608-114">Перенаправление небезопасных запросов на защищенные конечные точки.</span><span class="sxs-lookup"><span data-stu-id="a8608-114">Redirect insecure requests to secure endpoints.</span></span>
* <span data-ttu-id="a8608-115">Запрет вставки прямых ссылок, когда внешний сайт использует статический ресурс, размещенный на другом сайте, привязывая ресурс к своему содержимому.</span><span class="sxs-lookup"><span data-stu-id="a8608-115">Prevent hotlinking, where an external site uses a hosted static asset on another site by linking the asset into its own content.</span></span>

> [!NOTE]
> <span data-ttu-id="a8608-116">Переопределение URL-адресов может снижать производительность приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-116">URL rewriting can reduce the performance of an app.</span></span> <span data-ttu-id="a8608-117">Следует по возможности ограничить число и сложность правил.</span><span class="sxs-lookup"><span data-stu-id="a8608-117">Where feasible, limit the number and complexity of rules.</span></span>

<span data-ttu-id="a8608-118">[Просмотреть или скачать образец кода](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/) ([как скачивать](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="a8608-118">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="url-redirect-and-url-rewrite"></a><span data-ttu-id="a8608-119">Перенаправление и переопределение URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-119">URL redirect and URL rewrite</span></span>

<span data-ttu-id="a8608-120">Разница между *перенаправлением* и *переопределением* URL-адресов может показаться незначительной, но она оказывает существенное влияние на предоставление ресурсов клиентам.</span><span class="sxs-lookup"><span data-stu-id="a8608-120">The difference in wording between *URL redirect* and *URL rewrite* is subtle but has important implications for providing resources to clients.</span></span> <span data-ttu-id="a8608-121">ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core удовлетворяет потребность в обеих этих функциях.</span><span class="sxs-lookup"><span data-stu-id="a8608-121">ASP.NET Core's URL Rewriting Middleware is capable of meeting the need for both.</span></span>

<span data-ttu-id="a8608-122">*Перенаправление URL-адресов* является операцией на стороне клиента, которая предписывает клиенту обратиться к ресурсу по другому адресу, отличному от запрошенного клиентом.</span><span class="sxs-lookup"><span data-stu-id="a8608-122">A *URL redirect* involves a client-side operation, where the client is instructed to access a resource at a different address than the client originally requested.</span></span> <span data-ttu-id="a8608-123">Для этого используется круговое обращение к серверу.</span><span class="sxs-lookup"><span data-stu-id="a8608-123">This requires a round trip to the server.</span></span> <span data-ttu-id="a8608-124">URL-адрес перенаправления, возвращаемый клиенту, отображается в адресной строке браузера, когда клиент отправляет новый запрос для данного ресурса.</span><span class="sxs-lookup"><span data-stu-id="a8608-124">The redirect URL returned to the client appears in the browser's address bar when the client makes a new request for the resource.</span></span>

<span data-ttu-id="a8608-125">Если `/resource`*перенаправляется* на `/different-resource`, сервер отвечает, что клиенту следует получить ресурс в `/different-resource` с кодом состояния, указывающим, что такое перенаправление является временным или постоянным.</span><span class="sxs-lookup"><span data-stu-id="a8608-125">If `/resource` is *redirected* to `/different-resource`, the server responds that the client should obtain the resource at `/different-resource` with a status code indicating that the redirect is either temporary or permanent.</span></span>

![Конечная точка службы WebAPI временно изменена с версии 1 (v1) на версию 2 (v2) на сервере.](url-rewriting/_static/url_redirect.png)

<span data-ttu-id="a8608-131">При перенаправлении запросов на другой URL-адрес можно указать, является ли оно постоянным или временным, предоставив код состояния в ответе:</span><span class="sxs-lookup"><span data-stu-id="a8608-131">When redirecting requests to a different URL, indicate whether the redirect is permanent or temporary by specifying the status code with the response:</span></span>

* <span data-ttu-id="a8608-132">Код состояния *301 (перемещен окончательно)* используется, когда ресурс имеет новый постоянный URL-адрес и вы хотите сообщить клиенту, что все последующие запросы для этого ресурса должны использовать новый URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="a8608-132">The *301 - Moved Permanently* status code is used where the resource has a new, permanent URL and you wish to instruct the client that all future requests for the resource should use the new URL.</span></span> <span data-ttu-id="a8608-133">*Клиент может кэшировать и повторно использовать отклик при получении кода состояния 301.*</span><span class="sxs-lookup"><span data-stu-id="a8608-133">*The client may cache and reuse the response when a 301 status code is received.*</span></span>

* <span data-ttu-id="a8608-134">Код состояния *302 (найдено)* используется, когда перенаправление является временным или может меняться.</span><span class="sxs-lookup"><span data-stu-id="a8608-134">The *302 - Found* status code is used where the redirection is temporary or generally subject to change.</span></span> <span data-ttu-id="a8608-135">Код состояния 302 указывает клиенту, что не нужно сохранять URL-адрес и использовать его в будущем.</span><span class="sxs-lookup"><span data-stu-id="a8608-135">The 302 status code indicates to the client not to store the URL and use it in the future.</span></span>

<span data-ttu-id="a8608-136">Дополнительные сведения о кодах состояния см. в документе [RFC 2616: определения кодов состояния](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html).</span><span class="sxs-lookup"><span data-stu-id="a8608-136">For more information on status codes, see [RFC 2616: Status Code Definitions](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html).</span></span>

<span data-ttu-id="a8608-137">*Переопределение URL-адреса* является операцией на стороне сервера для предоставления ресурса с другого адреса ресурса, отличного от запрошенного клиентом.</span><span class="sxs-lookup"><span data-stu-id="a8608-137">A *URL rewrite* is a server-side operation that provides a resource from a different resource address than the client requested.</span></span> <span data-ttu-id="a8608-138">Переопределение URL-адреса не требует кругового обращения к серверу.</span><span class="sxs-lookup"><span data-stu-id="a8608-138">Rewriting a URL doesn't require a round trip to the server.</span></span> <span data-ttu-id="a8608-139">Переопределенный URL-адрес не возвращается клиенту и не отображается в адресной строке браузера.</span><span class="sxs-lookup"><span data-stu-id="a8608-139">The rewritten URL isn't returned to the client and doesn't appear in the browser's address bar.</span></span>

<span data-ttu-id="a8608-140">Когда `/resource`*переопределяется* на `/different-resource`, сервер получает и запрашивает ресурс *внутри* в `/different-resource`.</span><span class="sxs-lookup"><span data-stu-id="a8608-140">If `/resource` is *rewritten* to `/different-resource`, the server *internally* fetches and returns the resource at `/different-resource`.</span></span>

<span data-ttu-id="a8608-141">Хотя клиент может быть в состоянии получить ресурс по переопределенному URL-адресу, когда клиент отправляет запрос и получает отклик, он не уведомляется о наличии ресурса по переопределенному URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="a8608-141">Although the client might be able to retrieve the resource at the rewritten URL, the client isn't informed that the resource exists at the rewritten URL when it makes its request and receives the response.</span></span>

![Конечная точка службы WebAPI была изменена с версии 1 (v1) на версию 2 (v2) на сервере.](url-rewriting/_static/url_rewrite.png)

## <a name="url-rewriting-sample-app"></a><span data-ttu-id="a8608-146">Пример приложения с переопределением URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-146">URL rewriting sample app</span></span>

<span data-ttu-id="a8608-147">Вы можете ознакомиться с функциями ПО промежуточного слоя переопределения URL-адресов на [примере приложения](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/).</span><span class="sxs-lookup"><span data-stu-id="a8608-147">You can explore the features of the URL Rewriting Middleware with the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/).</span></span> <span data-ttu-id="a8608-148">Это приложение применяет правила перенаправления и переопределения и показывает перенаправленный или переопределенный URL-адрес для нескольких сценариев.</span><span class="sxs-lookup"><span data-stu-id="a8608-148">The app applies redirect and rewrite rules and shows the redirected or rewritten URL for several scenarios.</span></span>

## <a name="when-to-use-url-rewriting-middleware"></a><span data-ttu-id="a8608-149">Условия для использования ПО промежуточного слоя для переопределения URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-149">When to use URL Rewriting Middleware</span></span>

<span data-ttu-id="a8608-150">Используйте ПО промежуточного слоя для переопределения URL-адресов, если невозможно использовать следующие подходы:</span><span class="sxs-lookup"><span data-stu-id="a8608-150">Use URL Rewriting Middleware when you're unable to use the following approaches:</span></span>

* [<span data-ttu-id="a8608-151">Модуль переопределения URL-адресов со службами IIS на Windows Server</span><span class="sxs-lookup"><span data-stu-id="a8608-151">URL Rewrite module with IIS on Windows Server</span></span>](https://www.iis.net/downloads/microsoft/url-rewrite)
* [<span data-ttu-id="a8608-152">Модуль Apache mod_rewrite на сервере Apache Server</span><span class="sxs-lookup"><span data-stu-id="a8608-152">Apache mod_rewrite module on Apache Server</span></span>](https://httpd.apache.org/docs/2.4/rewrite/)
* [<span data-ttu-id="a8608-153">Переопределение URL-адресов в Nginx</span><span class="sxs-lookup"><span data-stu-id="a8608-153">URL rewriting on Nginx</span></span>](https://www.nginx.com/blog/creating-nginx-rewrite-rules/)

<span data-ttu-id="a8608-154">Кроме того, используйте ПО промежуточного слоя, когда приложение размещается на [сервере HTTP.sys](xref:fundamentals/servers/httpsys) (который раньше назывался WebListener).</span><span class="sxs-lookup"><span data-stu-id="a8608-154">Also, use the middleware when the app is hosted on [HTTP.sys server](xref:fundamentals/servers/httpsys) (formerly called WebListener).</span></span>

<span data-ttu-id="a8608-155">Основные причины для использования переопределения URL-адресов на основе сервера в IIS, Apache и Nginx:</span><span class="sxs-lookup"><span data-stu-id="a8608-155">The main reasons to use the server-based URL rewriting technologies in IIS, Apache, and Nginx are:</span></span>

* <span data-ttu-id="a8608-156">ПО промежуточного слоя не поддерживает все функции этих модулей.</span><span class="sxs-lookup"><span data-stu-id="a8608-156">The middleware doesn't support the full features of these modules.</span></span>

  <span data-ttu-id="a8608-157">Некоторые функции серверных модулей не работают с проектами ASP.NET Core, например ограничения `IsFile` и `IsDirectory` для модуля переопределения IIS.</span><span class="sxs-lookup"><span data-stu-id="a8608-157">Some of the features of the server modules don't work with ASP.NET Core projects, such as the `IsFile` and `IsDirectory` constraints of the IIS Rewrite module.</span></span> <span data-ttu-id="a8608-158">В этих случаях следует использовать ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="a8608-158">In these scenarios, use the middleware instead.</span></span>
* <span data-ttu-id="a8608-159">Производительность ПО промежуточного слоя, скорее всего, не соответствует производительности модулей.</span><span class="sxs-lookup"><span data-stu-id="a8608-159">The performance of the middleware probably doesn't match that of the modules.</span></span>

  <span data-ttu-id="a8608-160">Тестирование производительности — это единственный способ узнать точно, какой подход больше всего снижает производительность или является ли такое снижение незначительным.</span><span class="sxs-lookup"><span data-stu-id="a8608-160">Benchmarking is the only way to know for sure which approach degrades performance the most or if degraded performance is negligible.</span></span>

## <a name="package"></a><span data-ttu-id="a8608-161">Пакет</span><span class="sxs-lookup"><span data-stu-id="a8608-161">Package</span></span>

<span data-ttu-id="a8608-162">ПО промежуточного слоя перезаписи URL-адресов предоставляется пакетом [Microsoft.AspNetCore.Rewrite](https://www.nuget.org/packages/Microsoft.AspNetCore.Rewrite), который неявно включается в приложения ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a8608-162">URL Rewriting Middleware is provided by the [Microsoft.AspNetCore.Rewrite](https://www.nuget.org/packages/Microsoft.AspNetCore.Rewrite) package, which is implicitly included in ASP.NET Core apps.</span></span>

## <a name="extension-and-options"></a><span data-ttu-id="a8608-163">Расширение и параметры</span><span class="sxs-lookup"><span data-stu-id="a8608-163">Extension and options</span></span>

<span data-ttu-id="a8608-164">Задайте правила переопределения и перенаправления URL-адресов, создав экземпляр класса [RewriteOptions](xref:Microsoft.AspNetCore.Rewrite.RewriteOptions) для каждого правила с помощью методов расширения.</span><span class="sxs-lookup"><span data-stu-id="a8608-164">Establish URL rewrite and redirect rules by creating an instance of the [RewriteOptions](xref:Microsoft.AspNetCore.Rewrite.RewriteOptions) class with extension methods for each of your rewrite rules.</span></span> <span data-ttu-id="a8608-165">Несколько правил можно объединить в цепочку в том порядке, в котором они должны обрабатываться.</span><span class="sxs-lookup"><span data-stu-id="a8608-165">Chain multiple rules in the order that you would like them processed.</span></span> <span data-ttu-id="a8608-166">`RewriteOptions` передаются в ПО промежуточного слоя для переопределения URL-адресов по мере его добавления в конвейер запросов с помощью <xref:Microsoft.AspNetCore.Builder.RewriteBuilderExtensions.UseRewriter*>:</span><span class="sxs-lookup"><span data-stu-id="a8608-166">The `RewriteOptions` are passed into the URL Rewriting Middleware as it's added to the request pipeline with <xref:Microsoft.AspNetCore.Builder.RewriteBuilderExtensions.UseRewriter*>:</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1)]

### <a name="redirect-non-www-to-www"></a><span data-ttu-id="a8608-167">Перенаправление не www на www</span><span class="sxs-lookup"><span data-stu-id="a8608-167">Redirect non-www to www</span></span>

<span data-ttu-id="a8608-168">Три параметра разрешают приложению перенаправлять запросы, отличные от `www`, на `www`:</span><span class="sxs-lookup"><span data-stu-id="a8608-168">Three options permit the app to redirect non-`www` requests to `www`:</span></span>

* <span data-ttu-id="a8608-169"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWwwPermanent*>. Окончательно перенаправляет запрос в поддомен `www`, если запрос не является `www`.</span><span class="sxs-lookup"><span data-stu-id="a8608-169"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWwwPermanent*>: Permanently redirect the request to the `www` subdomain if the request is non-`www`.</span></span> <span data-ttu-id="a8608-170">Перенаправляет с кодом состояния [Status308PermanentRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status308PermanentRedirect).</span><span class="sxs-lookup"><span data-stu-id="a8608-170">Redirects with a [Status308PermanentRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status308PermanentRedirect) status code.</span></span>

* <span data-ttu-id="a8608-171"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWww*>. Перенаправляет запрос в поддомен `www`, если входящий запрос не является `www`.</span><span class="sxs-lookup"><span data-stu-id="a8608-171"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWww*>: Redirect the request to the `www` subdomain if the incoming request is non-`www`.</span></span> <span data-ttu-id="a8608-172">Перенаправляет с кодом состояния [Status307TemporaryRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status307TemporaryRedirect).</span><span class="sxs-lookup"><span data-stu-id="a8608-172">Redirects with a [Status307TemporaryRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status307TemporaryRedirect) status code.</span></span> <span data-ttu-id="a8608-173">Перегрузка позволяет предоставить код состояния для ответа.</span><span class="sxs-lookup"><span data-stu-id="a8608-173">An overload permits you to provide the status code for the response.</span></span> <span data-ttu-id="a8608-174">Используйте поле класса <xref:Microsoft.AspNetCore.Http.StatusCodes> для назначения кода состояния.</span><span class="sxs-lookup"><span data-stu-id="a8608-174">Use a field of the <xref:Microsoft.AspNetCore.Http.StatusCodes> class for a status code assignment.</span></span>

### <a name="url-redirect"></a><span data-ttu-id="a8608-175">Перенаправление URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-175">URL redirect</span></span>

<span data-ttu-id="a8608-176">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirect*> для перенаправления запросов.</span><span class="sxs-lookup"><span data-stu-id="a8608-176">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirect*> to redirect requests.</span></span> <span data-ttu-id="a8608-177">Первый параметр содержит регулярное выражение, соответствующее пути входящего URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-177">The first parameter contains your regex for matching on the path of the incoming URL.</span></span> <span data-ttu-id="a8608-178">Второй параметр является строкой замены.</span><span class="sxs-lookup"><span data-stu-id="a8608-178">The second parameter is the replacement string.</span></span> <span data-ttu-id="a8608-179">Третий параметр (при его наличии) указывает код состояния.</span><span class="sxs-lookup"><span data-stu-id="a8608-179">The third parameter, if present, specifies the status code.</span></span> <span data-ttu-id="a8608-180">Если код состояния не задан, по умолчанию используется код *302 (найдено)* , указывающий, что ресурс временно перемещен или заменен.</span><span class="sxs-lookup"><span data-stu-id="a8608-180">If you don't specify the status code, the status code defaults to *302 - Found*, which indicates that the resource is temporarily moved or replaced.</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1&highlight=9)]

<span data-ttu-id="a8608-181">В браузере с включенными средствами разработчика выполните запрос для примера приложения по пути `/redirect-rule/1234/5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-181">In a browser with developer tools enabled, make a request to the sample app with the path `/redirect-rule/1234/5678`.</span></span> <span data-ttu-id="a8608-182">Регулярное выражение соответствует пути запроса в `redirect-rule/(.*)`, и этот путь заменяется на `/redirected/1234/5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-182">The regex matches the request path on `redirect-rule/(.*)`, and the path is replaced with `/redirected/1234/5678`.</span></span> <span data-ttu-id="a8608-183">URL-адрес перенаправления отправляется обратно клиенту с кодом состояния *302 (найдено)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-183">The redirect URL is sent back to the client with a *302 - Found* status code.</span></span> <span data-ttu-id="a8608-184">Браузер выполняет новый запрос на URL-адрес перенаправления, отображаемый в адресной строке.</span><span class="sxs-lookup"><span data-stu-id="a8608-184">The browser makes a new request at the redirect URL, which appears in the browser's address bar.</span></span> <span data-ttu-id="a8608-185">Поскольку в примере приложения нет правил, соответствующих URL-адресу перенаправления:</span><span class="sxs-lookup"><span data-stu-id="a8608-185">Since no rules in the sample app match on the redirect URL:</span></span>

* <span data-ttu-id="a8608-186">Второй запрос получает от приложения ответ *200 (ОК)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-186">The second request receives a *200 - OK* response from the app.</span></span>
* <span data-ttu-id="a8608-187">Текст ответа показывает URL-адрес перенаправления.</span><span class="sxs-lookup"><span data-stu-id="a8608-187">The body of the response shows the redirect URL.</span></span>

<span data-ttu-id="a8608-188">При *перенаправлении* URL-адреса используется круговое обращение к серверу.</span><span class="sxs-lookup"><span data-stu-id="a8608-188">A round trip is made to the server when a URL is *redirected*.</span></span>

> [!WARNING]
> <span data-ttu-id="a8608-189">Соблюдайте осторожность при задании правил перенаправления.</span><span class="sxs-lookup"><span data-stu-id="a8608-189">Be cautious when establishing redirect rules.</span></span> <span data-ttu-id="a8608-190">Они оцениваются для каждого запроса, отправляемого в приложение, даже после перенаправления.</span><span class="sxs-lookup"><span data-stu-id="a8608-190">Redirect rules are evaluated on every request to the app, including after a redirect.</span></span> <span data-ttu-id="a8608-191">Можно легко случайно создать *бесконечный цикл перенаправлений*.</span><span class="sxs-lookup"><span data-stu-id="a8608-191">It's easy to accidentally create a *loop of infinite redirects*.</span></span>

<span data-ttu-id="a8608-192">Исходный запрос: `/redirect-rule/1234/5678`</span><span class="sxs-lookup"><span data-stu-id="a8608-192">Original Request: `/redirect-rule/1234/5678`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect.png)

<span data-ttu-id="a8608-194">Часть выражения, заключенная в скобки, называется *группой записи*.</span><span class="sxs-lookup"><span data-stu-id="a8608-194">The part of the expression contained within parentheses is called a *capture group*.</span></span> <span data-ttu-id="a8608-195">Точка (`.`) в выражении означает *совпадение с любым символом*.</span><span class="sxs-lookup"><span data-stu-id="a8608-195">The dot (`.`) of the expression means *match any character*.</span></span> <span data-ttu-id="a8608-196">Звездочка (`*`) означает *совпадение с предыдущим символом ноль или более раз*.</span><span class="sxs-lookup"><span data-stu-id="a8608-196">The asterisk (`*`) indicates *match the preceding character zero or more times*.</span></span> <span data-ttu-id="a8608-197">Таким образом, два последних сегмента пути URL-адреса, `1234/5678`, перехватываются группой записи `(.*)`.</span><span class="sxs-lookup"><span data-stu-id="a8608-197">Therefore, the last two path segments of the URL, `1234/5678`, are captured by capture group `(.*)`.</span></span> <span data-ttu-id="a8608-198">Любое значение, указанное в URL-адресе запроса после `redirect-rule/`, перехватывается этой группой записи.</span><span class="sxs-lookup"><span data-stu-id="a8608-198">Any value you provide in the request URL after `redirect-rule/` is captured by this single capture group.</span></span>

<span data-ttu-id="a8608-199">В строке замены группы записи внедряются с помощью знака доллара (`$`), за которым следует порядковый номер записи.</span><span class="sxs-lookup"><span data-stu-id="a8608-199">In the replacement string, captured groups are injected into the string with the dollar sign (`$`) followed by the sequence number of the capture.</span></span> <span data-ttu-id="a8608-200">Первое значение группы записи получается с помощью `$1`, второе — с помощью `$2`, после чего они продолжают по очереди использоваться для групп записи в регулярном выражении.</span><span class="sxs-lookup"><span data-stu-id="a8608-200">The first capture group value is obtained with `$1`, the second with `$2`, and they continue in sequence for the capture groups in your regex.</span></span> <span data-ttu-id="a8608-201">В регулярном выражении правила перенаправления в примере приложения присутствует всего одна группа записи, поэтому в строку замены внедряется тоже одна строка — `$1`.</span><span class="sxs-lookup"><span data-stu-id="a8608-201">There's only one captured group in the redirect rule regex in the sample app, so there's only one injected group in the replacement string, which is `$1`.</span></span> <span data-ttu-id="a8608-202">Когда применяется правило, URL-адрес становится `/redirected/1234/5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-202">When the rule is applied, the URL becomes `/redirected/1234/5678`.</span></span>

### <a name="url-redirect-to-a-secure-endpoint"></a><span data-ttu-id="a8608-203">Перенаправление URL-адресов на защищенную конечную точку</span><span class="sxs-lookup"><span data-stu-id="a8608-203">URL redirect to a secure endpoint</span></span>

<span data-ttu-id="a8608-204">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttps*>, чтобы перенаправлять HTTP-запросы на тот же узел и путь с использованием протокола HTTPS.</span><span class="sxs-lookup"><span data-stu-id="a8608-204">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttps*> to redirect HTTP requests to the same host and path using the HTTPS protocol.</span></span> <span data-ttu-id="a8608-205">Если код состояния не указан, ПО промежуточного слоя по умолчанию использует значение *302 (найдено)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-205">If the status code isn't supplied, the middleware defaults to *302 - Found*.</span></span> <span data-ttu-id="a8608-206">Если порт не указан:</span><span class="sxs-lookup"><span data-stu-id="a8608-206">If the port isn't supplied:</span></span>

* <span data-ttu-id="a8608-207">ПО промежуточного слоя по умолчанию устанавливается на `null`.</span><span class="sxs-lookup"><span data-stu-id="a8608-207">The middleware defaults to `null`.</span></span>
* <span data-ttu-id="a8608-208">Схема меняется на `https` (протокол HTTPS), и клиент обращается к ресурсу через порт 443.</span><span class="sxs-lookup"><span data-stu-id="a8608-208">The scheme changes to `https` (HTTPS protocol), and the client accesses the resource on port 443.</span></span>

<span data-ttu-id="a8608-209">Этот пример показывает, как задать код состояния *301 (перемещен окончательно)* и изменить порт на 5001.</span><span class="sxs-lookup"><span data-stu-id="a8608-209">The following example shows how to set the status code to *301 - Moved Permanently* and change the port to 5001.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    var options = new RewriteOptions()
        .AddRedirectToHttps(301, 5001);

    app.UseRewriter(options);
}
```

<span data-ttu-id="a8608-210">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttpsPermanent*>, чтобы перенаправить небезопасные запросы на тот же узел и путь с использованием безопасного протокола HTTPS через порт 443.</span><span class="sxs-lookup"><span data-stu-id="a8608-210">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttpsPermanent*> to redirect insecure requests to the same host and path with secure HTTPS protocol on port 443.</span></span> <span data-ttu-id="a8608-211">ПО промежуточного слоя задает код состояния *301 (перемещен окончательно)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-211">The middleware sets the status code to *301 - Moved Permanently*.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    var options = new RewriteOptions()
        .AddRedirectToHttpsPermanent();

    app.UseRewriter(options);
}
```

> [!NOTE]
> <span data-ttu-id="a8608-212">При перенаправлении на защищенную конечную точку без дополнительных правил перенаправления рекомендуется использовать ПО промежуточного слоя перенаправления на HTTPS.</span><span class="sxs-lookup"><span data-stu-id="a8608-212">When redirecting to a secure endpoint without the requirement for additional redirect rules, we recommend using HTTPS Redirection Middleware.</span></span> <span data-ttu-id="a8608-213">Дополнительные сведения см. в разделе [Обязательное использование HTTPS](xref:security/enforcing-ssl#require-https).</span><span class="sxs-lookup"><span data-stu-id="a8608-213">For more information, see the [Enforce HTTPS](xref:security/enforcing-ssl#require-https) topic.</span></span>

<span data-ttu-id="a8608-214">Пример приложения позволяет продемонстрировать использование `AddRedirectToHttps` или `AddRedirectToHttpsPermanent`.</span><span class="sxs-lookup"><span data-stu-id="a8608-214">The sample app is capable of demonstrating how to use `AddRedirectToHttps` or `AddRedirectToHttpsPermanent`.</span></span> <span data-ttu-id="a8608-215">Добавьте этот метод расширения в `RewriteOptions`.</span><span class="sxs-lookup"><span data-stu-id="a8608-215">Add the extension method to the `RewriteOptions`.</span></span> <span data-ttu-id="a8608-216">Выполните небезопасный запрос к приложению по любому URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="a8608-216">Make an insecure request to the app at any URL.</span></span> <span data-ttu-id="a8608-217">Закройте предостережение системы безопасности о том, что самозаверяющий сертификат не является доверенным, или создайте исключение, чтобы сделать сертификат доверенным.</span><span class="sxs-lookup"><span data-stu-id="a8608-217">Dismiss the browser security warning that the self-signed certificate is untrusted or create an exception to trust the certificate.</span></span>

<span data-ttu-id="a8608-218">Исходный запрос с использованием `AddRedirectToHttps(301, 5001)`: `http://localhost:5000/secure`</span><span class="sxs-lookup"><span data-stu-id="a8608-218">Original Request using `AddRedirectToHttps(301, 5001)`: `http://localhost:5000/secure`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect_to_https.png)

<span data-ttu-id="a8608-220">Исходный запрос с использованием `AddRedirectToHttpsPermanent`: `http://localhost:5000/secure`</span><span class="sxs-lookup"><span data-stu-id="a8608-220">Original Request using `AddRedirectToHttpsPermanent`: `http://localhost:5000/secure`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect_to_https_permanent.png)

### <a name="url-rewrite"></a><span data-ttu-id="a8608-222">Переопределение URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-222">URL rewrite</span></span>

<span data-ttu-id="a8608-223">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRewrite*>, чтобы создать правило для переопределения URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="a8608-223">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRewrite*> to create a rule for rewriting URLs.</span></span> <span data-ttu-id="a8608-224">Первый параметр содержит регулярное выражение, соответствующее пути входящего URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-224">The first parameter contains the regex for matching on the incoming URL path.</span></span> <span data-ttu-id="a8608-225">Второй параметр является строкой замены.</span><span class="sxs-lookup"><span data-stu-id="a8608-225">The second parameter is the replacement string.</span></span> <span data-ttu-id="a8608-226">Третий параметр `skipRemainingRules: {true|false}` сообщает ПО промежуточного слоя, нужно ли пропустить дополнительные правила переопределения, если применяется текущее правило.</span><span class="sxs-lookup"><span data-stu-id="a8608-226">The third parameter, `skipRemainingRules: {true|false}`, indicates to the middleware whether or not to skip additional rewrite rules if the current rule is applied.</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1&highlight=10-11)]

<span data-ttu-id="a8608-227">Исходный запрос: `/rewrite-rule/1234/5678`</span><span class="sxs-lookup"><span data-stu-id="a8608-227">Original Request: `/rewrite-rule/1234/5678`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запрос и отклик](url-rewriting/_static/add_rewrite.png)

<span data-ttu-id="a8608-229">Карет (`^`) в начале выражение означает, что сопоставление начинается с начала URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-229">The carat (`^`) at the beginning of the expression means that matching starts at the beginning of the URL path.</span></span>

<span data-ttu-id="a8608-230">В предыдущем примере с правилом перенаправления, `redirect-rule/(.*)`, в начале регулярного выражения нет символа `^`.</span><span class="sxs-lookup"><span data-stu-id="a8608-230">In the earlier example with the redirect rule, `redirect-rule/(.*)`, there's no carat (`^`) at the start of the regex.</span></span> <span data-ttu-id="a8608-231">Таким образом, для успешного совпадения до `redirect-rule/` в пути могут стоять любые символы.</span><span class="sxs-lookup"><span data-stu-id="a8608-231">Therefore, any characters may precede `redirect-rule/` in the path for a successful match.</span></span>

| <span data-ttu-id="a8608-232">Path</span><span class="sxs-lookup"><span data-stu-id="a8608-232">Path</span></span>                               | <span data-ttu-id="a8608-233">Соответствие</span><span class="sxs-lookup"><span data-stu-id="a8608-233">Match</span></span> |
| ---------------------------------- | :---: |
| `/redirect-rule/1234/5678`         | <span data-ttu-id="a8608-234">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-234">Yes</span></span>   |
| `/my-cool-redirect-rule/1234/5678` | <span data-ttu-id="a8608-235">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-235">Yes</span></span>   |
| `/anotherredirect-rule/1234/5678`  | <span data-ttu-id="a8608-236">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-236">Yes</span></span>   |

<span data-ttu-id="a8608-237">Правило переопределения `^rewrite-rule/(\d+)/(\d+)` соответствует путям, только если они начинаются с `rewrite-rule/`.</span><span class="sxs-lookup"><span data-stu-id="a8608-237">The rewrite rule, `^rewrite-rule/(\d+)/(\d+)`, only matches paths if they start with `rewrite-rule/`.</span></span> <span data-ttu-id="a8608-238">В следующей таблице обратите внимание на разницу в сопоставлении.</span><span class="sxs-lookup"><span data-stu-id="a8608-238">In the following table, note the difference in matching.</span></span>

| <span data-ttu-id="a8608-239">Path</span><span class="sxs-lookup"><span data-stu-id="a8608-239">Path</span></span>                              | <span data-ttu-id="a8608-240">Соответствие</span><span class="sxs-lookup"><span data-stu-id="a8608-240">Match</span></span> |
| --------------------------------- | :---: |
| `/rewrite-rule/1234/5678`         | <span data-ttu-id="a8608-241">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-241">Yes</span></span>   |
| `/my-cool-rewrite-rule/1234/5678` | <span data-ttu-id="a8608-242">Нет</span><span class="sxs-lookup"><span data-stu-id="a8608-242">No</span></span>    |
| `/anotherrewrite-rule/1234/5678`  | <span data-ttu-id="a8608-243">Нет</span><span class="sxs-lookup"><span data-stu-id="a8608-243">No</span></span>    |

<span data-ttu-id="a8608-244">После части `^rewrite-rule/` выражения стоят две группы записи `(\d+)/(\d+)`.</span><span class="sxs-lookup"><span data-stu-id="a8608-244">Following the `^rewrite-rule/` portion of the expression, there are two capture groups, `(\d+)/(\d+)`.</span></span> <span data-ttu-id="a8608-245">`\d` означает *соответствие цифре (числу)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-245">The `\d` signifies *match a digit (number)*.</span></span> <span data-ttu-id="a8608-246">Знак "плюс" (`+`) означает *соответствие одному или нескольким предшествующим символам*.</span><span class="sxs-lookup"><span data-stu-id="a8608-246">The plus sign (`+`) means *match one or more of the preceding character*.</span></span> <span data-ttu-id="a8608-247">Таким образом, URL-адрес должен содержать число, за которым идет прямая косая черта, за которой идет другое число.</span><span class="sxs-lookup"><span data-stu-id="a8608-247">Therefore, the URL must contain a number followed by a forward-slash followed by another number.</span></span> <span data-ttu-id="a8608-248">Эти группы записи внедряются в переопределенный URL-адрес как `$1` и `$2`.</span><span class="sxs-lookup"><span data-stu-id="a8608-248">These capture groups are injected into the rewritten URL as `$1` and `$2`.</span></span> <span data-ttu-id="a8608-249">Строка замены для правила переопределения помещает группы записи в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="a8608-249">The rewrite rule replacement string places the captured groups into the query string.</span></span> <span data-ttu-id="a8608-250">Запрошенный путь `/rewrite-rule/1234/5678` переопределяется, чтобы ресурс можно было получить по адресу `/rewritten?var1=1234&var2=5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-250">The requested path of `/rewrite-rule/1234/5678` is rewritten to obtain the resource at `/rewritten?var1=1234&var2=5678`.</span></span> <span data-ttu-id="a8608-251">Если в исходном запросе присутствует строка запроса, она сохраняется при переопределении URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-251">If a query string is present on the original request, it's preserved when the URL is rewritten.</span></span>

<span data-ttu-id="a8608-252">Круговое обращение к серверу для получения ресурса не выполняется.</span><span class="sxs-lookup"><span data-stu-id="a8608-252">There's no round trip to the server to obtain the resource.</span></span> <span data-ttu-id="a8608-253">Если ресурс существует, он извлекается и возвращается клиенту с кодом состояния *200 (ОК)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-253">If the resource exists, it's fetched and returned to the client with a *200 - OK* status code.</span></span> <span data-ttu-id="a8608-254">Так как клиент не перенаправляется, URL-адрес в адресной строке браузера не изменяется.</span><span class="sxs-lookup"><span data-stu-id="a8608-254">Because the client isn't redirected, the URL in the browser's address bar doesn't change.</span></span> <span data-ttu-id="a8608-255">Клиенты не могут узнать, что на сервере произошла операция переопределения URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-255">Clients can't detect that a URL rewrite operation occurred on the server.</span></span>

> [!NOTE]
> <span data-ttu-id="a8608-256">Используйте `skipRemainingRules: true` при любой возможности, так как правила сопоставления потребляют много ресурсов и ухудшают время отклика приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-256">Use `skipRemainingRules: true` whenever possible because matching rules is computationally expensive and increases app response time.</span></span> <span data-ttu-id="a8608-257">Чтобы максимально ускорить отклик приложения:</span><span class="sxs-lookup"><span data-stu-id="a8608-257">For the fastest app response:</span></span>
>
> * <span data-ttu-id="a8608-258">расположите правила переопределения в порядке от наиболее к наименее часто используемому;</span><span class="sxs-lookup"><span data-stu-id="a8608-258">Order rewrite rules from the most frequently matched rule to the least frequently matched rule.</span></span>
> * <span data-ttu-id="a8608-259">пропускайте обработку оставшихся правил, когда совпадение найдено и обработка дополнительных правил не требуется.</span><span class="sxs-lookup"><span data-stu-id="a8608-259">Skip the processing of the remaining rules when a match occurs and no additional rule processing is required.</span></span>

### <a name="apache-mod_rewrite"></a><span data-ttu-id="a8608-260">Apache mod_rewrite</span><span class="sxs-lookup"><span data-stu-id="a8608-260">Apache mod_rewrite</span></span>

<span data-ttu-id="a8608-261">Для применения правил mod_rewrite Apache можно использовать <xref:Microsoft.AspNetCore.Rewrite.ApacheModRewriteOptionsExtensions.AddApacheModRewrite*>.</span><span class="sxs-lookup"><span data-stu-id="a8608-261">Apply Apache mod_rewrite rules with <xref:Microsoft.AspNetCore.Rewrite.ApacheModRewriteOptionsExtensions.AddApacheModRewrite*>.</span></span> <span data-ttu-id="a8608-262">Убедитесь, что файл правил развертывается вместе с приложением.</span><span class="sxs-lookup"><span data-stu-id="a8608-262">Make sure that the rules file is deployed with the app.</span></span> <span data-ttu-id="a8608-263">Дополнительные сведения и примеры правил mod_rewrite см. в статье о [правилах mod_rewrite Apache](https://httpd.apache.org/docs/2.4/rewrite/).</span><span class="sxs-lookup"><span data-stu-id="a8608-263">For more information and examples of mod_rewrite rules, see [Apache mod_rewrite](https://httpd.apache.org/docs/2.4/rewrite/).</span></span>

<span data-ttu-id="a8608-264"><xref:System.IO.StreamReader> используется для чтения правил из файла *ApacheModRewrite.txt*:</span><span class="sxs-lookup"><span data-stu-id="a8608-264">A <xref:System.IO.StreamReader> is used to read the rules from the *ApacheModRewrite.txt* rules file:</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1&highlight=3-4,12)]

<span data-ttu-id="a8608-265">Пример приложения перенаправляет запросы из `/apache-mod-rules-redirect/(.\*)` в `/redirected?id=$1`.</span><span class="sxs-lookup"><span data-stu-id="a8608-265">The sample app redirects requests from `/apache-mod-rules-redirect/(.\*)` to `/redirected?id=$1`.</span></span> <span data-ttu-id="a8608-266">Отклик имеет код состояния *302 (найдено)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-266">The response status code is *302 - Found*.</span></span>

[!code[](url-rewriting/samples/3.x/SampleApp/ApacheModRewrite.txt)]

<span data-ttu-id="a8608-267">Исходный запрос: `/apache-mod-rules-redirect/1234`</span><span class="sxs-lookup"><span data-stu-id="a8608-267">Original Request: `/apache-mod-rules-redirect/1234`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_apache_mod_redirect.png)

<span data-ttu-id="a8608-269">ПО промежуточного слоя поддерживает следующие переменные сервера в mod_rewrite Apache:</span><span class="sxs-lookup"><span data-stu-id="a8608-269">The middleware supports the following Apache mod_rewrite server variables:</span></span>

* <span data-ttu-id="a8608-270">CONN_REMOTE_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-270">CONN_REMOTE_ADDR</span></span>
* <span data-ttu-id="a8608-271">HTTP_ACCEPT</span><span class="sxs-lookup"><span data-stu-id="a8608-271">HTTP_ACCEPT</span></span>
* <span data-ttu-id="a8608-272">HTTP_CONNECTION</span><span class="sxs-lookup"><span data-stu-id="a8608-272">HTTP_CONNECTION</span></span>
* <span data-ttu-id="a8608-273">HTTP_COOKIE</span><span class="sxs-lookup"><span data-stu-id="a8608-273">HTTP_COOKIE</span></span>
* <span data-ttu-id="a8608-274">HTTP_FORWARDED</span><span class="sxs-lookup"><span data-stu-id="a8608-274">HTTP_FORWARDED</span></span>
* <span data-ttu-id="a8608-275">HTTP_HOST</span><span class="sxs-lookup"><span data-stu-id="a8608-275">HTTP_HOST</span></span>
* <span data-ttu-id="a8608-276">HTTP_REFERER</span><span class="sxs-lookup"><span data-stu-id="a8608-276">HTTP_REFERER</span></span>
* <span data-ttu-id="a8608-277">HTTP_USER_AGENT</span><span class="sxs-lookup"><span data-stu-id="a8608-277">HTTP_USER_AGENT</span></span>
* <span data-ttu-id="a8608-278">HTTPS</span><span class="sxs-lookup"><span data-stu-id="a8608-278">HTTPS</span></span>
* <span data-ttu-id="a8608-279">IPV6</span><span class="sxs-lookup"><span data-stu-id="a8608-279">IPV6</span></span>
* <span data-ttu-id="a8608-280">QUERY_STRING</span><span class="sxs-lookup"><span data-stu-id="a8608-280">QUERY_STRING</span></span>
* <span data-ttu-id="a8608-281">REMOTE_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-281">REMOTE_ADDR</span></span>
* <span data-ttu-id="a8608-282">REMOTE_PORT</span><span class="sxs-lookup"><span data-stu-id="a8608-282">REMOTE_PORT</span></span>
* <span data-ttu-id="a8608-283">REQUEST_FILENAME</span><span class="sxs-lookup"><span data-stu-id="a8608-283">REQUEST_FILENAME</span></span>
* <span data-ttu-id="a8608-284">REQUEST_METHOD</span><span class="sxs-lookup"><span data-stu-id="a8608-284">REQUEST_METHOD</span></span>
* <span data-ttu-id="a8608-285">REQUEST_SCHEME</span><span class="sxs-lookup"><span data-stu-id="a8608-285">REQUEST_SCHEME</span></span>
* <span data-ttu-id="a8608-286">REQUEST_URI</span><span class="sxs-lookup"><span data-stu-id="a8608-286">REQUEST_URI</span></span>
* <span data-ttu-id="a8608-287">SCRIPT_FILENAME</span><span class="sxs-lookup"><span data-stu-id="a8608-287">SCRIPT_FILENAME</span></span>
* <span data-ttu-id="a8608-288">SERVER_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-288">SERVER_ADDR</span></span>
* <span data-ttu-id="a8608-289">SERVER_PORT</span><span class="sxs-lookup"><span data-stu-id="a8608-289">SERVER_PORT</span></span>
* <span data-ttu-id="a8608-290">SERVER_PROTOCOL</span><span class="sxs-lookup"><span data-stu-id="a8608-290">SERVER_PROTOCOL</span></span>
* <span data-ttu-id="a8608-291">TIME</span><span class="sxs-lookup"><span data-stu-id="a8608-291">TIME</span></span>
* <span data-ttu-id="a8608-292">TIME_DAY</span><span class="sxs-lookup"><span data-stu-id="a8608-292">TIME_DAY</span></span>
* <span data-ttu-id="a8608-293">TIME_HOUR</span><span class="sxs-lookup"><span data-stu-id="a8608-293">TIME_HOUR</span></span>
* <span data-ttu-id="a8608-294">TIME_MIN</span><span class="sxs-lookup"><span data-stu-id="a8608-294">TIME_MIN</span></span>
* <span data-ttu-id="a8608-295">TIME_MON</span><span class="sxs-lookup"><span data-stu-id="a8608-295">TIME_MON</span></span>
* <span data-ttu-id="a8608-296">TIME_SEC</span><span class="sxs-lookup"><span data-stu-id="a8608-296">TIME_SEC</span></span>
* <span data-ttu-id="a8608-297">TIME_WDAY</span><span class="sxs-lookup"><span data-stu-id="a8608-297">TIME_WDAY</span></span>
* <span data-ttu-id="a8608-298">TIME_YEAR</span><span class="sxs-lookup"><span data-stu-id="a8608-298">TIME_YEAR</span></span>

### <a name="iis-url-rewrite-module-rules"></a><span data-ttu-id="a8608-299">Правила модуля переопределения URL-адресов для IIS</span><span class="sxs-lookup"><span data-stu-id="a8608-299">IIS URL Rewrite Module rules</span></span>

<span data-ttu-id="a8608-300">Чтобы использовать тот же набор правил, который применяется к модулю переопределения URL-адресов для IIS, используйте <xref:Microsoft.AspNetCore.Rewrite.IISUrlRewriteOptionsExtensions.AddIISUrlRewrite*>.</span><span class="sxs-lookup"><span data-stu-id="a8608-300">To use the same rule set that applies to the IIS URL Rewrite Module, use <xref:Microsoft.AspNetCore.Rewrite.IISUrlRewriteOptionsExtensions.AddIISUrlRewrite*>.</span></span> <span data-ttu-id="a8608-301">Убедитесь, что файл правил развертывается вместе с приложением.</span><span class="sxs-lookup"><span data-stu-id="a8608-301">Make sure that the rules file is deployed with the app.</span></span> <span data-ttu-id="a8608-302">Не указывайте ПО промежуточного слоя использовать файл приложения *web.config* при работе в службах IIS Windows Server.</span><span class="sxs-lookup"><span data-stu-id="a8608-302">Don't direct the middleware to use the app's *web.config* file when running on Windows Server IIS.</span></span> <span data-ttu-id="a8608-303">В IIS эти правила нужно хранить за пределами файла приложения *web.config*, чтобы предотвратить конфликты с модулем переопределения для IIS.</span><span class="sxs-lookup"><span data-stu-id="a8608-303">With IIS, these rules should be stored outside of the app's *web.config* file in order to avoid conflicts with the IIS Rewrite module.</span></span> <span data-ttu-id="a8608-304">Дополнительные сведения и примеры правил модуля переопределения URL-адресов для IIS см. в разделах [Использование модуля переопределения URL-адресов 2.0](/iis/extensions/url-rewrite-module/using-url-rewrite-module-20) и [Справочник по конфигурации модуля переопределения URL-адресов](/iis/extensions/url-rewrite-module/url-rewrite-module-configuration-reference).</span><span class="sxs-lookup"><span data-stu-id="a8608-304">For more information and examples of IIS URL Rewrite Module rules, see [Using Url Rewrite Module 2.0](/iis/extensions/url-rewrite-module/using-url-rewrite-module-20) and [URL Rewrite Module Configuration Reference](/iis/extensions/url-rewrite-module/url-rewrite-module-configuration-reference).</span></span>

<span data-ttu-id="a8608-305"><xref:System.IO.StreamReader> используется для чтения правил из файла *IISUrlRewrite.xml*:</span><span class="sxs-lookup"><span data-stu-id="a8608-305">A <xref:System.IO.StreamReader> is used to read the rules from the *IISUrlRewrite.xml* rules file:</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1&highlight=5-6,13)]

<span data-ttu-id="a8608-306">Пример приложения переопределяет запросы с `/iis-rules-rewrite/(.*)` на `/rewritten?id=$1`.</span><span class="sxs-lookup"><span data-stu-id="a8608-306">The sample app rewrites requests from `/iis-rules-rewrite/(.*)` to `/rewritten?id=$1`.</span></span> <span data-ttu-id="a8608-307">Клиенту отправляется отклик с кодом состояния *200 (ОК)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-307">The response is sent to the client with a *200 - OK* status code.</span></span>

[!code-xml[](url-rewriting/samples/3.x/SampleApp/IISUrlRewrite.xml)]

<span data-ttu-id="a8608-308">Исходный запрос: `/iis-rules-rewrite/1234`</span><span class="sxs-lookup"><span data-stu-id="a8608-308">Original Request: `/iis-rules-rewrite/1234`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запрос и отклик](url-rewriting/_static/add_iis_url_rewrite.png)

<span data-ttu-id="a8608-310">Если имеется активный модуль переопределения для IIS, где настроены правила брандмауэра уровня сервера, способные негативно повлиять на ваше приложение, можно отключить этот модуль для приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-310">If you have an active IIS Rewrite Module with server-level rules configured that would impact your app in undesirable ways, you can disable the IIS Rewrite Module for an app.</span></span> <span data-ttu-id="a8608-311">Дополнительные сведения см. в разделе [Отключение модулей IIS](xref:host-and-deploy/iis/modules#disabling-iis-modules).</span><span class="sxs-lookup"><span data-stu-id="a8608-311">For more information, see [Disabling IIS modules](xref:host-and-deploy/iis/modules#disabling-iis-modules).</span></span>

#### <a name="unsupported-features"></a><span data-ttu-id="a8608-312">Неподдерживаемые функции</span><span class="sxs-lookup"><span data-stu-id="a8608-312">Unsupported features</span></span>

<span data-ttu-id="a8608-313">ПО промежуточного слоя не поддерживает следующие функции в модуле переопределения URL-адресов для служб IIS:</span><span class="sxs-lookup"><span data-stu-id="a8608-313">The middleware doesn't support the following IIS URL Rewrite Module features:</span></span>

* <span data-ttu-id="a8608-314">Правила для исходящих подключений</span><span class="sxs-lookup"><span data-stu-id="a8608-314">Outbound Rules</span></span>
* <span data-ttu-id="a8608-315">Пользовательские переменные сервера</span><span class="sxs-lookup"><span data-stu-id="a8608-315">Custom Server Variables</span></span>
* <span data-ttu-id="a8608-316">Знаки подстановки</span><span class="sxs-lookup"><span data-stu-id="a8608-316">Wildcards</span></span>
* <span data-ttu-id="a8608-317">LogRewrittenUrl</span><span class="sxs-lookup"><span data-stu-id="a8608-317">LogRewrittenUrl</span></span>

#### <a name="supported-server-variables"></a><span data-ttu-id="a8608-318">Поддерживаемые переменные сервера</span><span class="sxs-lookup"><span data-stu-id="a8608-318">Supported server variables</span></span>

<span data-ttu-id="a8608-319">ПО промежуточного слоя поддерживает следующие переменные сервера в модуле переопределения URL-адресов для IIS:</span><span class="sxs-lookup"><span data-stu-id="a8608-319">The middleware supports the following IIS URL Rewrite Module server variables:</span></span>

* <span data-ttu-id="a8608-320">CONTENT_LENGTH</span><span class="sxs-lookup"><span data-stu-id="a8608-320">CONTENT_LENGTH</span></span>
* <span data-ttu-id="a8608-321">CONTENT_TYPE</span><span class="sxs-lookup"><span data-stu-id="a8608-321">CONTENT_TYPE</span></span>
* <span data-ttu-id="a8608-322">HTTP_ACCEPT</span><span class="sxs-lookup"><span data-stu-id="a8608-322">HTTP_ACCEPT</span></span>
* <span data-ttu-id="a8608-323">HTTP_CONNECTION</span><span class="sxs-lookup"><span data-stu-id="a8608-323">HTTP_CONNECTION</span></span>
* <span data-ttu-id="a8608-324">HTTP_COOKIE</span><span class="sxs-lookup"><span data-stu-id="a8608-324">HTTP_COOKIE</span></span>
* <span data-ttu-id="a8608-325">HTTP_HOST</span><span class="sxs-lookup"><span data-stu-id="a8608-325">HTTP_HOST</span></span>
* <span data-ttu-id="a8608-326">HTTP_REFERER</span><span class="sxs-lookup"><span data-stu-id="a8608-326">HTTP_REFERER</span></span>
* <span data-ttu-id="a8608-327">HTTP_URL</span><span class="sxs-lookup"><span data-stu-id="a8608-327">HTTP_URL</span></span>
* <span data-ttu-id="a8608-328">HTTP_USER_AGENT</span><span class="sxs-lookup"><span data-stu-id="a8608-328">HTTP_USER_AGENT</span></span>
* <span data-ttu-id="a8608-329">HTTPS</span><span class="sxs-lookup"><span data-stu-id="a8608-329">HTTPS</span></span>
* <span data-ttu-id="a8608-330">LOCAL_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-330">LOCAL_ADDR</span></span>
* <span data-ttu-id="a8608-331">QUERY_STRING</span><span class="sxs-lookup"><span data-stu-id="a8608-331">QUERY_STRING</span></span>
* <span data-ttu-id="a8608-332">REMOTE_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-332">REMOTE_ADDR</span></span>
* <span data-ttu-id="a8608-333">REMOTE_PORT</span><span class="sxs-lookup"><span data-stu-id="a8608-333">REMOTE_PORT</span></span>
* <span data-ttu-id="a8608-334">REQUEST_FILENAME</span><span class="sxs-lookup"><span data-stu-id="a8608-334">REQUEST_FILENAME</span></span>
* <span data-ttu-id="a8608-335">REQUEST_URI</span><span class="sxs-lookup"><span data-stu-id="a8608-335">REQUEST_URI</span></span>

> [!NOTE]
> <span data-ttu-id="a8608-336">Можно также получить <xref:Microsoft.Extensions.FileProviders.IFileProvider> через <xref:Microsoft.Extensions.FileProviders.PhysicalFileProvider>.</span><span class="sxs-lookup"><span data-stu-id="a8608-336">You can also obtain an <xref:Microsoft.Extensions.FileProviders.IFileProvider> via a <xref:Microsoft.Extensions.FileProviders.PhysicalFileProvider>.</span></span> <span data-ttu-id="a8608-337">Такой подход позволяет более гибко задавать расположение для файлов с правилами переопределения.</span><span class="sxs-lookup"><span data-stu-id="a8608-337">This approach may provide greater flexibility for the location of your rewrite rules files.</span></span> <span data-ttu-id="a8608-338">Убедитесь, что эти файлы развертываются на сервере по указанному пути.</span><span class="sxs-lookup"><span data-stu-id="a8608-338">Make sure that your rewrite rules files are deployed to the server at the path you provide.</span></span>
>
> ```csharp
> PhysicalFileProvider fileProvider = new PhysicalFileProvider(Directory.GetCurrentDirectory());
> ```

### <a name="method-based-rule"></a><span data-ttu-id="a8608-339">Правило, основанное на методе</span><span class="sxs-lookup"><span data-stu-id="a8608-339">Method-based rule</span></span>

<span data-ttu-id="a8608-340">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*>, чтобы реализовать собственную логику правил в методе.</span><span class="sxs-lookup"><span data-stu-id="a8608-340">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*> to implement your own rule logic in a method.</span></span> <span data-ttu-id="a8608-341">`Add` предоставляет <xref:Microsoft.AspNetCore.Rewrite.RewriteContext>, который предоставляет <xref:Microsoft.AspNetCore.Http.HttpContext> для использования в методе.</span><span class="sxs-lookup"><span data-stu-id="a8608-341">`Add` exposes the <xref:Microsoft.AspNetCore.Rewrite.RewriteContext>, which makes available the <xref:Microsoft.AspNetCore.Http.HttpContext> for use in your method.</span></span> <span data-ttu-id="a8608-342">[RewriteContext.Result](xref:Microsoft.AspNetCore.Rewrite.RewriteContext.Result*) определяет, как осуществляется дополнительная обработка в конвейере.</span><span class="sxs-lookup"><span data-stu-id="a8608-342">The [RewriteContext.Result](xref:Microsoft.AspNetCore.Rewrite.RewriteContext.Result*) determines how additional pipeline processing is handled.</span></span> <span data-ttu-id="a8608-343">Установите значение одного из полей <xref:Microsoft.AspNetCore.Rewrite.RuleResult> из следующей таблицы.</span><span class="sxs-lookup"><span data-stu-id="a8608-343">Set the value to one of the <xref:Microsoft.AspNetCore.Rewrite.RuleResult> fields described in the following table.</span></span>

| <span data-ttu-id="a8608-344">Результат перезаписи контекста</span><span class="sxs-lookup"><span data-stu-id="a8608-344">Rewrite context result</span></span>               | <span data-ttu-id="a8608-345">Действие</span><span class="sxs-lookup"><span data-stu-id="a8608-345">Action</span></span>                                                           |
| ------------------------------------ | ---------------------------------------------------------------- |
| <span data-ttu-id="a8608-346">`RuleResult.ContinueRules` (по умолчанию)</span><span class="sxs-lookup"><span data-stu-id="a8608-346">`RuleResult.ContinueRules` (default)</span></span> | <span data-ttu-id="a8608-347">Продолжение применения правил.</span><span class="sxs-lookup"><span data-stu-id="a8608-347">Continue applying rules.</span></span>                                         |
| `RuleResult.EndResponse`             | <span data-ttu-id="a8608-348">Остановка применения правил и отправка отклика.</span><span class="sxs-lookup"><span data-stu-id="a8608-348">Stop applying rules and send the response.</span></span>                       |
| `RuleResult.SkipRemainingRules`      | <span data-ttu-id="a8608-349">Остановка применения правил и отправка контекста в следующий компонент ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="a8608-349">Stop applying rules and send the context to the next middleware.</span></span> |

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1&highlight=14)]

<span data-ttu-id="a8608-350">Пример приложения демонстрирует метод, который перенаправляет запросы для путей, заканчивающихся на *.xml*.</span><span class="sxs-lookup"><span data-stu-id="a8608-350">The sample app demonstrates a method that redirects requests for paths that end with *.xml*.</span></span> <span data-ttu-id="a8608-351">Если запрос выполняется для `/file.xml`, запрос перенаправляется к `/xmlfiles/file.xml`.</span><span class="sxs-lookup"><span data-stu-id="a8608-351">If a request is made for `/file.xml`, the request is redirected to `/xmlfiles/file.xml`.</span></span> <span data-ttu-id="a8608-352">Для кода состояния задается значение *301 (перемещен окончательно)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-352">The status code is set to *301 - Moved Permanently*.</span></span> <span data-ttu-id="a8608-353">Когда браузер отправляет новый запрос на */xmlfiles/file.xml*, ПО промежуточного слоя статических файлов предоставляет файл клиенту из папки *wwwroot/xmlfiles*.</span><span class="sxs-lookup"><span data-stu-id="a8608-353">When the browser makes a new request for */xmlfiles/file.xml*, Static File Middleware serves the file to the client from the *wwwroot/xmlfiles* folder.</span></span> <span data-ttu-id="a8608-354">Для перенаправления необходимо явно указать код состояния ответа.</span><span class="sxs-lookup"><span data-stu-id="a8608-354">For a redirect, explicitly set the status code of the response.</span></span> <span data-ttu-id="a8608-355">В противном случае возвращается код состояния *200 (ОК)* и перенаправление на стороне клиента не происходит.</span><span class="sxs-lookup"><span data-stu-id="a8608-355">Otherwise, a *200 - OK* status code is returned, and the redirect doesn't occur on the client.</span></span>

<span data-ttu-id="a8608-356">*RewriteRules.cs*:</span><span class="sxs-lookup"><span data-stu-id="a8608-356">*RewriteRules.cs*:</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/RewriteRules.cs?name=snippet_RedirectXmlFileRequests&highlight=14-18)]

<span data-ttu-id="a8608-357">Этот подход также переопределяет запросы.</span><span class="sxs-lookup"><span data-stu-id="a8608-357">This approach can also rewrite requests.</span></span> <span data-ttu-id="a8608-358">В примере приложения показано переопределение пути для любого запроса текстового файла, чтобы отправить текстовый файл *file.txt* из папки *wwwroot*.</span><span class="sxs-lookup"><span data-stu-id="a8608-358">The sample app demonstrates rewriting the path for any text file request to serve the *file.txt* text file from the *wwwroot* folder.</span></span> <span data-ttu-id="a8608-359">ПО промежуточного слоя статических файлов предоставляет файл по обновленному пути запроса:</span><span class="sxs-lookup"><span data-stu-id="a8608-359">Static File Middleware serves the file based on the updated request path:</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1&highlight=15,22)]

<span data-ttu-id="a8608-360">*RewriteRules.cs*:</span><span class="sxs-lookup"><span data-stu-id="a8608-360">*RewriteRules.cs*:</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/RewriteRules.cs?name=snippet_RewriteTextFileRequests&highlight=7-8)]

### <a name="irule-based-rule"></a><span data-ttu-id="a8608-361">Правило, основанное на IRule</span><span class="sxs-lookup"><span data-stu-id="a8608-361">IRule-based rule</span></span>

<span data-ttu-id="a8608-362">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*>, чтобы использовать собственную логику правил в классе, реализующем интерфейс <xref:Microsoft.AspNetCore.Rewrite.IRule>.</span><span class="sxs-lookup"><span data-stu-id="a8608-362">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*> to use rule logic in a class that implements the <xref:Microsoft.AspNetCore.Rewrite.IRule> interface.</span></span> <span data-ttu-id="a8608-363">`IRule` позволяет более гибко применять правила, основанные на методах.</span><span class="sxs-lookup"><span data-stu-id="a8608-363">`IRule` provides greater flexibility over using the method-based rule approach.</span></span> <span data-ttu-id="a8608-364">Класс реализации может включать конструктор, который позволяет передавать параметры для метода <xref:Microsoft.AspNetCore.Rewrite.IRule.ApplyRule*>.</span><span class="sxs-lookup"><span data-stu-id="a8608-364">Your implementation class may include a constructor that allows you can pass in parameters for the <xref:Microsoft.AspNetCore.Rewrite.IRule.ApplyRule*> method.</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/Startup.cs?name=snippet1&highlight=16-17)]

<span data-ttu-id="a8608-365">Значения параметров в примере приложения для `extension` и `newPath` проверяются на соответствие нескольким условиям.</span><span class="sxs-lookup"><span data-stu-id="a8608-365">The values of the parameters in the sample app for the `extension` and the `newPath` are checked to meet several conditions.</span></span> <span data-ttu-id="a8608-366">`extension` должен содержать одно из значений: *.png*, *.jpg* или *.gif*.</span><span class="sxs-lookup"><span data-stu-id="a8608-366">The `extension` must contain a value, and the value must be *.png*, *.jpg*, or *.gif*.</span></span> <span data-ttu-id="a8608-367">Если `newPath` не является допустимым, возникает исключение <xref:System.ArgumentException>.</span><span class="sxs-lookup"><span data-stu-id="a8608-367">If the `newPath` isn't valid, an <xref:System.ArgumentException> is thrown.</span></span> <span data-ttu-id="a8608-368">Если запрос выполняется для *image.png*, запрос перенаправляется к `/png-images/image.png`.</span><span class="sxs-lookup"><span data-stu-id="a8608-368">If a request is made for *image.png*, the request is redirected to `/png-images/image.png`.</span></span> <span data-ttu-id="a8608-369">Если запрос выполняется для *image.jpg*, запрос перенаправляется к `/jpg-images/image.jpg`.</span><span class="sxs-lookup"><span data-stu-id="a8608-369">If a request is made for *image.jpg*, the request is redirected to `/jpg-images/image.jpg`.</span></span> <span data-ttu-id="a8608-370">Для кода состояния устанавливается значение *301 (перемещен окончательно)* , а также задается `context.Result`, чтобы остановить обработку правил и отправить отклик.</span><span class="sxs-lookup"><span data-stu-id="a8608-370">The status code is set to *301 - Moved Permanently*, and the `context.Result` is set to stop processing rules and send the response.</span></span>

[!code-csharp[](url-rewriting/samples/3.x/SampleApp/RewriteRules.cs?name=snippet_RedirectImageRequests)]

<span data-ttu-id="a8608-371">Исходный запрос: `/image.png`</span><span class="sxs-lookup"><span data-stu-id="a8608-371">Original Request: `/image.png`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики для image.png](url-rewriting/_static/add_redirect_png_requests.png)

<span data-ttu-id="a8608-373">Исходный запрос: `/image.jpg`</span><span class="sxs-lookup"><span data-stu-id="a8608-373">Original Request: `/image.jpg`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики для image.jpg](url-rewriting/_static/add_redirect_jpg_requests.png)

## <a name="regex-examples"></a><span data-ttu-id="a8608-375">Примеры регулярных выражений</span><span class="sxs-lookup"><span data-stu-id="a8608-375">Regex examples</span></span>

| <span data-ttu-id="a8608-376">Goal</span><span class="sxs-lookup"><span data-stu-id="a8608-376">Goal</span></span> | <span data-ttu-id="a8608-377">Пример строки регулярного выражения</span><span class="sxs-lookup"><span data-stu-id="a8608-377">Regex String &</span></span><br><span data-ttu-id="a8608-378">и совпадения</span><span class="sxs-lookup"><span data-stu-id="a8608-378">Match Example</span></span> | <span data-ttu-id="a8608-379">Пример строки замены и</span><span class="sxs-lookup"><span data-stu-id="a8608-379">Replacement String &</span></span><br><span data-ttu-id="a8608-380">выходных данных</span><span class="sxs-lookup"><span data-stu-id="a8608-380">Output Example</span></span> |
| ---- | ------------------------------- | -------------------------------------- |
| <span data-ttu-id="a8608-381">Переопределение пути в строке запроса</span><span class="sxs-lookup"><span data-stu-id="a8608-381">Rewrite path into querystring</span></span> | `^path/(.*)/(.*)`<br>`/path/abc/123` | `path?var1=$1&var2=$2`<br>`/path?var1=abc&var2=123` |
| <span data-ttu-id="a8608-382">Удаление косой черты в конце</span><span class="sxs-lookup"><span data-stu-id="a8608-382">Strip trailing slash</span></span> | `(.*)/$`<br>`/path/` | `$1`<br>`/path` |
| <span data-ttu-id="a8608-383">Добавление косой черты в конце</span><span class="sxs-lookup"><span data-stu-id="a8608-383">Enforce trailing slash</span></span> | `(.*[^/])$`<br>`/path` | `$1/`<br>`/path/` |
| <span data-ttu-id="a8608-384">Запрет переопределения отдельных запросов</span><span class="sxs-lookup"><span data-stu-id="a8608-384">Avoid rewriting specific requests</span></span> | <span data-ttu-id="a8608-385">`^(.*)(?<!\.axd)$` или `^(?!.*\.axd$)(.*)$`</span><span class="sxs-lookup"><span data-stu-id="a8608-385">`^(.*)(?<!\.axd)$` or `^(?!.*\.axd$)(.*)$`</span></span><br><span data-ttu-id="a8608-386">Да: `/resource.htm`</span><span class="sxs-lookup"><span data-stu-id="a8608-386">Yes: `/resource.htm`</span></span><br><span data-ttu-id="a8608-387">Нет: `/resource.axd`</span><span class="sxs-lookup"><span data-stu-id="a8608-387">No: `/resource.axd`</span></span> | `rewritten/$1`<br>`/rewritten/resource.htm`<br>`/resource.axd` |
| <span data-ttu-id="a8608-388">Переупорядочение сегментов URL-адреса</span><span class="sxs-lookup"><span data-stu-id="a8608-388">Rearrange URL segments</span></span> | `path/(.*)/(.*)/(.*)`<br>`path/1/2/3` | `path/$3/$2/$1`<br>`path/3/2/1` |
| <span data-ttu-id="a8608-389">Замена сегмента URL-адреса</span><span class="sxs-lookup"><span data-stu-id="a8608-389">Replace a URL segment</span></span> | `^(.*)/segment2/(.*)`<br>`/segment1/segment2/segment3` | `$1/replaced/$2`<br>`/segment1/replaced/segment3` |

::: moniker-end

::: moniker range="< aspnetcore-3.0"

<span data-ttu-id="a8608-390">Этот документ содержит вводные сведения о переопределении URL-адресов и инструкции по использованию ПО промежуточного слоя для переопределения URL-адресов в приложениях ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a8608-390">This document introduces URL rewriting with instructions on how to use URL Rewriting Middleware in ASP.NET Core apps.</span></span>

<span data-ttu-id="a8608-391">Переопределение URL-адресов представляет собой изменение URL-адресов запросов на основе одного или нескольких предопределенных правил.</span><span class="sxs-lookup"><span data-stu-id="a8608-391">URL rewriting is the act of modifying request URLs based on one or more predefined rules.</span></span> <span data-ttu-id="a8608-392">Переопределение URL-адресов создает абстракцию между расположениями ресурсов и их адресами, позволяя убрать тесную связь между ними.</span><span class="sxs-lookup"><span data-stu-id="a8608-392">URL rewriting creates an abstraction between resource locations and their addresses so that the locations and addresses aren't tightly linked.</span></span> <span data-ttu-id="a8608-393">Существует несколько сценариев, где может пригодиться переопределение URL-адресов:</span><span class="sxs-lookup"><span data-stu-id="a8608-393">URL rewriting is valuable in several scenarios to:</span></span>

* <span data-ttu-id="a8608-394">Временное или постоянное перемещение или замещение ресурсов сервера с сохранением стабильных указателей для этих ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a8608-394">Move or replace server resources temporarily or permanently and maintain stable locators for those resources.</span></span>
* <span data-ttu-id="a8608-395">Разделение обработки запросов между разными приложениями или разными областями одного приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-395">Split request processing across different apps or across areas of one app.</span></span>
* <span data-ttu-id="a8608-396">Удаление, добавление или переупорядочение сегментов URL-адресов для входящих запросов.</span><span class="sxs-lookup"><span data-stu-id="a8608-396">Remove, add, or reorganize URL segments on incoming requests.</span></span>
* <span data-ttu-id="a8608-397">Оптимизация общедоступных URL-адресов в целях оптимизации для поисковых систем (SEO).</span><span class="sxs-lookup"><span data-stu-id="a8608-397">Optimize public URLs for Search Engine Optimization (SEO).</span></span>
* <span data-ttu-id="a8608-398">Разрешение использования понятных общедоступных URL-адресов, чтобы помочь посетителям прогнозировать содержимое, возвращаемое в результате запроса ресурса.</span><span class="sxs-lookup"><span data-stu-id="a8608-398">Permit the use of friendly public URLs to help visitors predict the content returned by requesting a resource.</span></span>
* <span data-ttu-id="a8608-399">Перенаправление небезопасных запросов на защищенные конечные точки.</span><span class="sxs-lookup"><span data-stu-id="a8608-399">Redirect insecure requests to secure endpoints.</span></span>
* <span data-ttu-id="a8608-400">Запрет вставки прямых ссылок, когда внешний сайт использует статический ресурс, размещенный на другом сайте, привязывая ресурс к своему содержимому.</span><span class="sxs-lookup"><span data-stu-id="a8608-400">Prevent hotlinking, where an external site uses a hosted static asset on another site by linking the asset into its own content.</span></span>

> [!NOTE]
> <span data-ttu-id="a8608-401">Переопределение URL-адресов может снижать производительность приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-401">URL rewriting can reduce the performance of an app.</span></span> <span data-ttu-id="a8608-402">Следует по возможности ограничить число и сложность правил.</span><span class="sxs-lookup"><span data-stu-id="a8608-402">Where feasible, limit the number and complexity of rules.</span></span>

<span data-ttu-id="a8608-403">[Просмотреть или скачать образец кода](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/) ([как скачивать](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="a8608-403">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="url-redirect-and-url-rewrite"></a><span data-ttu-id="a8608-404">Перенаправление и переопределение URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-404">URL redirect and URL rewrite</span></span>

<span data-ttu-id="a8608-405">Разница между *перенаправлением* и *переопределением* URL-адресов может показаться незначительной, но она оказывает существенное влияние на предоставление ресурсов клиентам.</span><span class="sxs-lookup"><span data-stu-id="a8608-405">The difference in wording between *URL redirect* and *URL rewrite* is subtle but has important implications for providing resources to clients.</span></span> <span data-ttu-id="a8608-406">ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core удовлетворяет потребность в обеих этих функциях.</span><span class="sxs-lookup"><span data-stu-id="a8608-406">ASP.NET Core's URL Rewriting Middleware is capable of meeting the need for both.</span></span>

<span data-ttu-id="a8608-407">*Перенаправление URL-адресов* является операцией на стороне клиента, которая предписывает клиенту обратиться к ресурсу по другому адресу, отличному от запрошенного клиентом.</span><span class="sxs-lookup"><span data-stu-id="a8608-407">A *URL redirect* involves a client-side operation, where the client is instructed to access a resource at a different address than the client originally requested.</span></span> <span data-ttu-id="a8608-408">Для этого используется круговое обращение к серверу.</span><span class="sxs-lookup"><span data-stu-id="a8608-408">This requires a round trip to the server.</span></span> <span data-ttu-id="a8608-409">URL-адрес перенаправления, возвращаемый клиенту, отображается в адресной строке браузера, когда клиент отправляет новый запрос для данного ресурса.</span><span class="sxs-lookup"><span data-stu-id="a8608-409">The redirect URL returned to the client appears in the browser's address bar when the client makes a new request for the resource.</span></span>

<span data-ttu-id="a8608-410">Если `/resource`*перенаправляется* на `/different-resource`, сервер отвечает, что клиенту следует получить ресурс в `/different-resource` с кодом состояния, указывающим, что такое перенаправление является временным или постоянным.</span><span class="sxs-lookup"><span data-stu-id="a8608-410">If `/resource` is *redirected* to `/different-resource`, the server responds that the client should obtain the resource at `/different-resource` with a status code indicating that the redirect is either temporary or permanent.</span></span>

![Конечная точка службы WebAPI временно изменена с версии 1 (v1) на версию 2 (v2) на сервере.](url-rewriting/_static/url_redirect.png)

<span data-ttu-id="a8608-416">При перенаправлении запросов на другой URL-адрес можно указать, является ли оно постоянным или временным, предоставив код состояния в ответе:</span><span class="sxs-lookup"><span data-stu-id="a8608-416">When redirecting requests to a different URL, indicate whether the redirect is permanent or temporary by specifying the status code with the response:</span></span>

* <span data-ttu-id="a8608-417">Код состояния *301 (перемещен окончательно)* используется, когда ресурс имеет новый постоянный URL-адрес и вы хотите сообщить клиенту, что все последующие запросы для этого ресурса должны использовать новый URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="a8608-417">The *301 - Moved Permanently* status code is used where the resource has a new, permanent URL and you wish to instruct the client that all future requests for the resource should use the new URL.</span></span> <span data-ttu-id="a8608-418">*Клиент может кэшировать и повторно использовать отклик при получении кода состояния 301.*</span><span class="sxs-lookup"><span data-stu-id="a8608-418">*The client may cache and reuse the response when a 301 status code is received.*</span></span>

* <span data-ttu-id="a8608-419">Код состояния *302 (найдено)* используется, когда перенаправление является временным или может меняться.</span><span class="sxs-lookup"><span data-stu-id="a8608-419">The *302 - Found* status code is used where the redirection is temporary or generally subject to change.</span></span> <span data-ttu-id="a8608-420">Код состояния 302 указывает клиенту, что не нужно сохранять URL-адрес и использовать его в будущем.</span><span class="sxs-lookup"><span data-stu-id="a8608-420">The 302 status code indicates to the client not to store the URL and use it in the future.</span></span>

<span data-ttu-id="a8608-421">Дополнительные сведения о кодах состояния см. в документе [RFC 2616: определения кодов состояния](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html).</span><span class="sxs-lookup"><span data-stu-id="a8608-421">For more information on status codes, see [RFC 2616: Status Code Definitions](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html).</span></span>

<span data-ttu-id="a8608-422">*Переопределение URL-адреса* является операцией на стороне сервера для предоставления ресурса с другого адреса ресурса, отличного от запрошенного клиентом.</span><span class="sxs-lookup"><span data-stu-id="a8608-422">A *URL rewrite* is a server-side operation that provides a resource from a different resource address than the client requested.</span></span> <span data-ttu-id="a8608-423">Переопределение URL-адреса не требует кругового обращения к серверу.</span><span class="sxs-lookup"><span data-stu-id="a8608-423">Rewriting a URL doesn't require a round trip to the server.</span></span> <span data-ttu-id="a8608-424">Переопределенный URL-адрес не возвращается клиенту и не отображается в адресной строке браузера.</span><span class="sxs-lookup"><span data-stu-id="a8608-424">The rewritten URL isn't returned to the client and doesn't appear in the browser's address bar.</span></span>

<span data-ttu-id="a8608-425">Когда `/resource`*переопределяется* на `/different-resource`, сервер получает и запрашивает ресурс *внутри* в `/different-resource`.</span><span class="sxs-lookup"><span data-stu-id="a8608-425">If `/resource` is *rewritten* to `/different-resource`, the server *internally* fetches and returns the resource at `/different-resource`.</span></span>

<span data-ttu-id="a8608-426">Хотя клиент может быть в состоянии получить ресурс по переопределенному URL-адресу, когда клиент отправляет запрос и получает отклик, он не уведомляется о наличии ресурса по переопределенному URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="a8608-426">Although the client might be able to retrieve the resource at the rewritten URL, the client isn't informed that the resource exists at the rewritten URL when it makes its request and receives the response.</span></span>

![Конечная точка службы WebAPI была изменена с версии 1 (v1) на версию 2 (v2) на сервере.](url-rewriting/_static/url_rewrite.png)

## <a name="url-rewriting-sample-app"></a><span data-ttu-id="a8608-431">Пример приложения с переопределением URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-431">URL rewriting sample app</span></span>

<span data-ttu-id="a8608-432">Вы можете ознакомиться с функциями ПО промежуточного слоя переопределения URL-адресов на [примере приложения](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/).</span><span class="sxs-lookup"><span data-stu-id="a8608-432">You can explore the features of the URL Rewriting Middleware with the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/url-rewriting/samples/).</span></span> <span data-ttu-id="a8608-433">Это приложение применяет правила перенаправления и переопределения и показывает перенаправленный или переопределенный URL-адрес для нескольких сценариев.</span><span class="sxs-lookup"><span data-stu-id="a8608-433">The app applies redirect and rewrite rules and shows the redirected or rewritten URL for several scenarios.</span></span>

## <a name="when-to-use-url-rewriting-middleware"></a><span data-ttu-id="a8608-434">Условия для использования ПО промежуточного слоя для переопределения URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-434">When to use URL Rewriting Middleware</span></span>

<span data-ttu-id="a8608-435">Используйте ПО промежуточного слоя для переопределения URL-адресов, если невозможно использовать следующие подходы:</span><span class="sxs-lookup"><span data-stu-id="a8608-435">Use URL Rewriting Middleware when you're unable to use the following approaches:</span></span>

* [<span data-ttu-id="a8608-436">Модуль переопределения URL-адресов со службами IIS на Windows Server</span><span class="sxs-lookup"><span data-stu-id="a8608-436">URL Rewrite module with IIS on Windows Server</span></span>](https://www.iis.net/downloads/microsoft/url-rewrite)
* [<span data-ttu-id="a8608-437">Модуль Apache mod_rewrite на сервере Apache Server</span><span class="sxs-lookup"><span data-stu-id="a8608-437">Apache mod_rewrite module on Apache Server</span></span>](https://httpd.apache.org/docs/2.4/rewrite/)
* [<span data-ttu-id="a8608-438">Переопределение URL-адресов в Nginx</span><span class="sxs-lookup"><span data-stu-id="a8608-438">URL rewriting on Nginx</span></span>](https://www.nginx.com/blog/creating-nginx-rewrite-rules/)

<span data-ttu-id="a8608-439">Кроме того, используйте ПО промежуточного слоя, когда приложение размещается на [сервере HTTP.sys](xref:fundamentals/servers/httpsys) (который раньше назывался WebListener).</span><span class="sxs-lookup"><span data-stu-id="a8608-439">Also, use the middleware when the app is hosted on [HTTP.sys server](xref:fundamentals/servers/httpsys) (formerly called WebListener).</span></span>

<span data-ttu-id="a8608-440">Основные причины для использования переопределения URL-адресов на основе сервера в IIS, Apache и Nginx:</span><span class="sxs-lookup"><span data-stu-id="a8608-440">The main reasons to use the server-based URL rewriting technologies in IIS, Apache, and Nginx are:</span></span>

* <span data-ttu-id="a8608-441">ПО промежуточного слоя не поддерживает все функции этих модулей.</span><span class="sxs-lookup"><span data-stu-id="a8608-441">The middleware doesn't support the full features of these modules.</span></span>

  <span data-ttu-id="a8608-442">Некоторые функции серверных модулей не работают с проектами ASP.NET Core, например ограничения `IsFile` и `IsDirectory` для модуля переопределения IIS.</span><span class="sxs-lookup"><span data-stu-id="a8608-442">Some of the features of the server modules don't work with ASP.NET Core projects, such as the `IsFile` and `IsDirectory` constraints of the IIS Rewrite module.</span></span> <span data-ttu-id="a8608-443">В этих случаях следует использовать ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="a8608-443">In these scenarios, use the middleware instead.</span></span>
* <span data-ttu-id="a8608-444">Производительность ПО промежуточного слоя, скорее всего, не соответствует производительности модулей.</span><span class="sxs-lookup"><span data-stu-id="a8608-444">The performance of the middleware probably doesn't match that of the modules.</span></span>

  <span data-ttu-id="a8608-445">Тестирование производительности — это единственный способ узнать точно, какой подход больше всего снижает производительность или является ли такое снижение незначительным.</span><span class="sxs-lookup"><span data-stu-id="a8608-445">Benchmarking is the only way to know for sure which approach degrades performance the most or if degraded performance is negligible.</span></span>

## <a name="package"></a><span data-ttu-id="a8608-446">Пакет</span><span class="sxs-lookup"><span data-stu-id="a8608-446">Package</span></span>

<span data-ttu-id="a8608-447">Чтобы включить ПО промежуточного слоя в проект, добавьте ссылки на пакет в [метапакет Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app) в файле проекта, который содержит пакет [Microsoft.AspNetCore.Rewrite](https://www.nuget.org/packages/Microsoft.AspNetCore.Rewrite).</span><span class="sxs-lookup"><span data-stu-id="a8608-447">To include the middleware in your project, add a package reference to the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app) in the project file, which contains the [Microsoft.AspNetCore.Rewrite](https://www.nuget.org/packages/Microsoft.AspNetCore.Rewrite) package.</span></span>

<span data-ttu-id="a8608-448">Если метапакет `Microsoft.AspNetCore.App` не используется, добавьте ссылку на проект в пакет `Microsoft.AspNetCore.Rewrite`.</span><span class="sxs-lookup"><span data-stu-id="a8608-448">When not using the `Microsoft.AspNetCore.App` metapackage, add a project reference to the `Microsoft.AspNetCore.Rewrite` package.</span></span>

## <a name="extension-and-options"></a><span data-ttu-id="a8608-449">Расширение и параметры</span><span class="sxs-lookup"><span data-stu-id="a8608-449">Extension and options</span></span>

<span data-ttu-id="a8608-450">Задайте правила переопределения и перенаправления URL-адресов, создав экземпляр класса [RewriteOptions](xref:Microsoft.AspNetCore.Rewrite.RewriteOptions) для каждого правила с помощью методов расширения.</span><span class="sxs-lookup"><span data-stu-id="a8608-450">Establish URL rewrite and redirect rules by creating an instance of the [RewriteOptions](xref:Microsoft.AspNetCore.Rewrite.RewriteOptions) class with extension methods for each of your rewrite rules.</span></span> <span data-ttu-id="a8608-451">Несколько правил можно объединить в цепочку в том порядке, в котором они должны обрабатываться.</span><span class="sxs-lookup"><span data-stu-id="a8608-451">Chain multiple rules in the order that you would like them processed.</span></span> <span data-ttu-id="a8608-452">`RewriteOptions` передаются в ПО промежуточного слоя для переопределения URL-адресов по мере его добавления в конвейер запросов с помощью <xref:Microsoft.AspNetCore.Builder.RewriteBuilderExtensions.UseRewriter*>:</span><span class="sxs-lookup"><span data-stu-id="a8608-452">The `RewriteOptions` are passed into the URL Rewriting Middleware as it's added to the request pipeline with <xref:Microsoft.AspNetCore.Builder.RewriteBuilderExtensions.UseRewriter*>:</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1)]

### <a name="redirect-non-www-to-www"></a><span data-ttu-id="a8608-453">Перенаправление не www на www</span><span class="sxs-lookup"><span data-stu-id="a8608-453">Redirect non-www to www</span></span>

<span data-ttu-id="a8608-454">Три параметра разрешают приложению перенаправлять запросы, отличные от `www`, на `www`:</span><span class="sxs-lookup"><span data-stu-id="a8608-454">Three options permit the app to redirect non-`www` requests to `www`:</span></span>

* <span data-ttu-id="a8608-455"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWwwPermanent*>. Окончательно перенаправляет запрос в поддомен `www`, если запрос не является `www`.</span><span class="sxs-lookup"><span data-stu-id="a8608-455"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWwwPermanent*>: Permanently redirect the request to the `www` subdomain if the request is non-`www`.</span></span> <span data-ttu-id="a8608-456">Перенаправляет с кодом состояния [Status308PermanentRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status308PermanentRedirect).</span><span class="sxs-lookup"><span data-stu-id="a8608-456">Redirects with a [Status308PermanentRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status308PermanentRedirect) status code.</span></span>

* <span data-ttu-id="a8608-457"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWww*>. Перенаправляет запрос в поддомен `www`, если входящий запрос не является `www`.</span><span class="sxs-lookup"><span data-stu-id="a8608-457"><xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWww*>: Redirect the request to the `www` subdomain if the incoming request is non-`www`.</span></span> <span data-ttu-id="a8608-458">Перенаправляет с кодом состояния [Status307TemporaryRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status307TemporaryRedirect).</span><span class="sxs-lookup"><span data-stu-id="a8608-458">Redirects with a [Status307TemporaryRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status307TemporaryRedirect) status code.</span></span> <span data-ttu-id="a8608-459">Перегрузка позволяет предоставить код состояния для ответа.</span><span class="sxs-lookup"><span data-stu-id="a8608-459">An overload permits you to provide the status code for the response.</span></span> <span data-ttu-id="a8608-460">Используйте поле класса <xref:Microsoft.AspNetCore.Http.StatusCodes> для назначения кода состояния.</span><span class="sxs-lookup"><span data-stu-id="a8608-460">Use a field of the <xref:Microsoft.AspNetCore.Http.StatusCodes> class for a status code assignment.</span></span>

### <a name="url-redirect"></a><span data-ttu-id="a8608-461">Перенаправление URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-461">URL redirect</span></span>

<span data-ttu-id="a8608-462">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirect*> для перенаправления запросов.</span><span class="sxs-lookup"><span data-stu-id="a8608-462">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirect*> to redirect requests.</span></span> <span data-ttu-id="a8608-463">Первый параметр содержит регулярное выражение, соответствующее пути входящего URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-463">The first parameter contains your regex for matching on the path of the incoming URL.</span></span> <span data-ttu-id="a8608-464">Второй параметр является строкой замены.</span><span class="sxs-lookup"><span data-stu-id="a8608-464">The second parameter is the replacement string.</span></span> <span data-ttu-id="a8608-465">Третий параметр (при его наличии) указывает код состояния.</span><span class="sxs-lookup"><span data-stu-id="a8608-465">The third parameter, if present, specifies the status code.</span></span> <span data-ttu-id="a8608-466">Если код состояния не задан, по умолчанию используется код *302 (найдено)* , указывающий, что ресурс временно перемещен или заменен.</span><span class="sxs-lookup"><span data-stu-id="a8608-466">If you don't specify the status code, the status code defaults to *302 - Found*, which indicates that the resource is temporarily moved or replaced.</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=9)]

<span data-ttu-id="a8608-467">В браузере с включенными средствами разработчика выполните запрос для примера приложения по пути `/redirect-rule/1234/5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-467">In a browser with developer tools enabled, make a request to the sample app with the path `/redirect-rule/1234/5678`.</span></span> <span data-ttu-id="a8608-468">Регулярное выражение соответствует пути запроса в `redirect-rule/(.*)`, и этот путь заменяется на `/redirected/1234/5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-468">The regex matches the request path on `redirect-rule/(.*)`, and the path is replaced with `/redirected/1234/5678`.</span></span> <span data-ttu-id="a8608-469">URL-адрес перенаправления отправляется обратно клиенту с кодом состояния *302 (найдено)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-469">The redirect URL is sent back to the client with a *302 - Found* status code.</span></span> <span data-ttu-id="a8608-470">Браузер выполняет новый запрос на URL-адрес перенаправления, отображаемый в адресной строке.</span><span class="sxs-lookup"><span data-stu-id="a8608-470">The browser makes a new request at the redirect URL, which appears in the browser's address bar.</span></span> <span data-ttu-id="a8608-471">Поскольку в примере приложения нет правил, соответствующих URL-адресу перенаправления:</span><span class="sxs-lookup"><span data-stu-id="a8608-471">Since no rules in the sample app match on the redirect URL:</span></span>

* <span data-ttu-id="a8608-472">Второй запрос получает от приложения ответ *200 (ОК)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-472">The second request receives a *200 - OK* response from the app.</span></span>
* <span data-ttu-id="a8608-473">Текст ответа показывает URL-адрес перенаправления.</span><span class="sxs-lookup"><span data-stu-id="a8608-473">The body of the response shows the redirect URL.</span></span>

<span data-ttu-id="a8608-474">При *перенаправлении* URL-адреса используется круговое обращение к серверу.</span><span class="sxs-lookup"><span data-stu-id="a8608-474">A round trip is made to the server when a URL is *redirected*.</span></span>

> [!WARNING]
> <span data-ttu-id="a8608-475">Соблюдайте осторожность при задании правил перенаправления.</span><span class="sxs-lookup"><span data-stu-id="a8608-475">Be cautious when establishing redirect rules.</span></span> <span data-ttu-id="a8608-476">Они оцениваются для каждого запроса, отправляемого в приложение, даже после перенаправления.</span><span class="sxs-lookup"><span data-stu-id="a8608-476">Redirect rules are evaluated on every request to the app, including after a redirect.</span></span> <span data-ttu-id="a8608-477">Можно легко случайно создать *бесконечный цикл перенаправлений*.</span><span class="sxs-lookup"><span data-stu-id="a8608-477">It's easy to accidentally create a *loop of infinite redirects*.</span></span>

<span data-ttu-id="a8608-478">Исходный запрос: `/redirect-rule/1234/5678`</span><span class="sxs-lookup"><span data-stu-id="a8608-478">Original Request: `/redirect-rule/1234/5678`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect.png)

<span data-ttu-id="a8608-480">Часть выражения, заключенная в скобки, называется *группой записи*.</span><span class="sxs-lookup"><span data-stu-id="a8608-480">The part of the expression contained within parentheses is called a *capture group*.</span></span> <span data-ttu-id="a8608-481">Точка (`.`) в выражении означает *совпадение с любым символом*.</span><span class="sxs-lookup"><span data-stu-id="a8608-481">The dot (`.`) of the expression means *match any character*.</span></span> <span data-ttu-id="a8608-482">Звездочка (`*`) означает *совпадение с предыдущим символом ноль или более раз*.</span><span class="sxs-lookup"><span data-stu-id="a8608-482">The asterisk (`*`) indicates *match the preceding character zero or more times*.</span></span> <span data-ttu-id="a8608-483">Таким образом, два последних сегмента пути URL-адреса, `1234/5678`, перехватываются группой записи `(.*)`.</span><span class="sxs-lookup"><span data-stu-id="a8608-483">Therefore, the last two path segments of the URL, `1234/5678`, are captured by capture group `(.*)`.</span></span> <span data-ttu-id="a8608-484">Любое значение, указанное в URL-адресе запроса после `redirect-rule/`, перехватывается этой группой записи.</span><span class="sxs-lookup"><span data-stu-id="a8608-484">Any value you provide in the request URL after `redirect-rule/` is captured by this single capture group.</span></span>

<span data-ttu-id="a8608-485">В строке замены группы записи внедряются с помощью знака доллара (`$`), за которым следует порядковый номер записи.</span><span class="sxs-lookup"><span data-stu-id="a8608-485">In the replacement string, captured groups are injected into the string with the dollar sign (`$`) followed by the sequence number of the capture.</span></span> <span data-ttu-id="a8608-486">Первое значение группы записи получается с помощью `$1`, второе — с помощью `$2`, после чего они продолжают по очереди использоваться для групп записи в регулярном выражении.</span><span class="sxs-lookup"><span data-stu-id="a8608-486">The first capture group value is obtained with `$1`, the second with `$2`, and they continue in sequence for the capture groups in your regex.</span></span> <span data-ttu-id="a8608-487">В регулярном выражении правила перенаправления в примере приложения присутствует всего одна группа записи, поэтому в строку замены внедряется тоже одна строка — `$1`.</span><span class="sxs-lookup"><span data-stu-id="a8608-487">There's only one captured group in the redirect rule regex in the sample app, so there's only one injected group in the replacement string, which is `$1`.</span></span> <span data-ttu-id="a8608-488">Когда применяется правило, URL-адрес становится `/redirected/1234/5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-488">When the rule is applied, the URL becomes `/redirected/1234/5678`.</span></span>

### <a name="url-redirect-to-a-secure-endpoint"></a><span data-ttu-id="a8608-489">Перенаправление URL-адресов на защищенную конечную точку</span><span class="sxs-lookup"><span data-stu-id="a8608-489">URL redirect to a secure endpoint</span></span>

<span data-ttu-id="a8608-490">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttps*>, чтобы перенаправлять HTTP-запросы на тот же узел и путь с использованием протокола HTTPS.</span><span class="sxs-lookup"><span data-stu-id="a8608-490">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttps*> to redirect HTTP requests to the same host and path using the HTTPS protocol.</span></span> <span data-ttu-id="a8608-491">Если код состояния не указан, ПО промежуточного слоя по умолчанию использует значение *302 (найдено)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-491">If the status code isn't supplied, the middleware defaults to *302 - Found*.</span></span> <span data-ttu-id="a8608-492">Если порт не указан:</span><span class="sxs-lookup"><span data-stu-id="a8608-492">If the port isn't supplied:</span></span>

* <span data-ttu-id="a8608-493">ПО промежуточного слоя по умолчанию устанавливается на `null`.</span><span class="sxs-lookup"><span data-stu-id="a8608-493">The middleware defaults to `null`.</span></span>
* <span data-ttu-id="a8608-494">Схема меняется на `https` (протокол HTTPS), и клиент обращается к ресурсу через порт 443.</span><span class="sxs-lookup"><span data-stu-id="a8608-494">The scheme changes to `https` (HTTPS protocol), and the client accesses the resource on port 443.</span></span>

<span data-ttu-id="a8608-495">Этот пример показывает, как задать код состояния *301 (перемещен окончательно)* и изменить порт на 5001.</span><span class="sxs-lookup"><span data-stu-id="a8608-495">The following example shows how to set the status code to *301 - Moved Permanently* and change the port to 5001.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    var options = new RewriteOptions()
        .AddRedirectToHttps(301, 5001);

    app.UseRewriter(options);
}
```

<span data-ttu-id="a8608-496">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttpsPermanent*>, чтобы перенаправить небезопасные запросы на тот же узел и путь с использованием безопасного протокола HTTPS через порт 443.</span><span class="sxs-lookup"><span data-stu-id="a8608-496">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttpsPermanent*> to redirect insecure requests to the same host and path with secure HTTPS protocol on port 443.</span></span> <span data-ttu-id="a8608-497">ПО промежуточного слоя задает код состояния *301 (перемещен окончательно)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-497">The middleware sets the status code to *301 - Moved Permanently*.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    var options = new RewriteOptions()
        .AddRedirectToHttpsPermanent();

    app.UseRewriter(options);
}
```

> [!NOTE]
> <span data-ttu-id="a8608-498">При перенаправлении на защищенную конечную точку без дополнительных правил перенаправления рекомендуется использовать ПО промежуточного слоя перенаправления на HTTPS.</span><span class="sxs-lookup"><span data-stu-id="a8608-498">When redirecting to a secure endpoint without the requirement for additional redirect rules, we recommend using HTTPS Redirection Middleware.</span></span> <span data-ttu-id="a8608-499">Дополнительные сведения см. в разделе [Обязательное использование HTTPS](xref:security/enforcing-ssl#require-https).</span><span class="sxs-lookup"><span data-stu-id="a8608-499">For more information, see the [Enforce HTTPS](xref:security/enforcing-ssl#require-https) topic.</span></span>

<span data-ttu-id="a8608-500">Пример приложения позволяет продемонстрировать использование `AddRedirectToHttps` или `AddRedirectToHttpsPermanent`.</span><span class="sxs-lookup"><span data-stu-id="a8608-500">The sample app is capable of demonstrating how to use `AddRedirectToHttps` or `AddRedirectToHttpsPermanent`.</span></span> <span data-ttu-id="a8608-501">Добавьте этот метод расширения в `RewriteOptions`.</span><span class="sxs-lookup"><span data-stu-id="a8608-501">Add the extension method to the `RewriteOptions`.</span></span> <span data-ttu-id="a8608-502">Выполните небезопасный запрос к приложению по любому URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="a8608-502">Make an insecure request to the app at any URL.</span></span> <span data-ttu-id="a8608-503">Закройте предостережение системы безопасности о том, что самозаверяющий сертификат не является доверенным, или создайте исключение, чтобы сделать сертификат доверенным.</span><span class="sxs-lookup"><span data-stu-id="a8608-503">Dismiss the browser security warning that the self-signed certificate is untrusted or create an exception to trust the certificate.</span></span>

<span data-ttu-id="a8608-504">Исходный запрос с использованием `AddRedirectToHttps(301, 5001)`: `http://localhost:5000/secure`</span><span class="sxs-lookup"><span data-stu-id="a8608-504">Original Request using `AddRedirectToHttps(301, 5001)`: `http://localhost:5000/secure`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect_to_https.png)

<span data-ttu-id="a8608-506">Исходный запрос с использованием `AddRedirectToHttpsPermanent`: `http://localhost:5000/secure`</span><span class="sxs-lookup"><span data-stu-id="a8608-506">Original Request using `AddRedirectToHttpsPermanent`: `http://localhost:5000/secure`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect_to_https_permanent.png)

### <a name="url-rewrite"></a><span data-ttu-id="a8608-508">Переопределение URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-508">URL rewrite</span></span>

<span data-ttu-id="a8608-509">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRewrite*>, чтобы создать правило для переопределения URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="a8608-509">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRewrite*> to create a rule for rewriting URLs.</span></span> <span data-ttu-id="a8608-510">Первый параметр содержит регулярное выражение, соответствующее пути входящего URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-510">The first parameter contains the regex for matching on the incoming URL path.</span></span> <span data-ttu-id="a8608-511">Второй параметр является строкой замены.</span><span class="sxs-lookup"><span data-stu-id="a8608-511">The second parameter is the replacement string.</span></span> <span data-ttu-id="a8608-512">Третий параметр `skipRemainingRules: {true|false}` сообщает ПО промежуточного слоя, нужно ли пропустить дополнительные правила переопределения, если применяется текущее правило.</span><span class="sxs-lookup"><span data-stu-id="a8608-512">The third parameter, `skipRemainingRules: {true|false}`, indicates to the middleware whether or not to skip additional rewrite rules if the current rule is applied.</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=10-11)]

<span data-ttu-id="a8608-513">Исходный запрос: `/rewrite-rule/1234/5678`</span><span class="sxs-lookup"><span data-stu-id="a8608-513">Original Request: `/rewrite-rule/1234/5678`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запрос и отклик](url-rewriting/_static/add_rewrite.png)

<span data-ttu-id="a8608-515">Карет (`^`) в начале выражение означает, что сопоставление начинается с начала URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-515">The carat (`^`) at the beginning of the expression means that matching starts at the beginning of the URL path.</span></span>

<span data-ttu-id="a8608-516">В предыдущем примере с правилом перенаправления, `redirect-rule/(.*)`, в начале регулярного выражения нет символа `^`.</span><span class="sxs-lookup"><span data-stu-id="a8608-516">In the earlier example with the redirect rule, `redirect-rule/(.*)`, there's no carat (`^`) at the start of the regex.</span></span> <span data-ttu-id="a8608-517">Таким образом, для успешного совпадения до `redirect-rule/` в пути могут стоять любые символы.</span><span class="sxs-lookup"><span data-stu-id="a8608-517">Therefore, any characters may precede `redirect-rule/` in the path for a successful match.</span></span>

| <span data-ttu-id="a8608-518">Path</span><span class="sxs-lookup"><span data-stu-id="a8608-518">Path</span></span>                               | <span data-ttu-id="a8608-519">Соответствие</span><span class="sxs-lookup"><span data-stu-id="a8608-519">Match</span></span> |
| ---------------------------------- | :---: |
| `/redirect-rule/1234/5678`         | <span data-ttu-id="a8608-520">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-520">Yes</span></span>   |
| `/my-cool-redirect-rule/1234/5678` | <span data-ttu-id="a8608-521">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-521">Yes</span></span>   |
| `/anotherredirect-rule/1234/5678`  | <span data-ttu-id="a8608-522">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-522">Yes</span></span>   |

<span data-ttu-id="a8608-523">Правило переопределения `^rewrite-rule/(\d+)/(\d+)` соответствует путям, только если они начинаются с `rewrite-rule/`.</span><span class="sxs-lookup"><span data-stu-id="a8608-523">The rewrite rule, `^rewrite-rule/(\d+)/(\d+)`, only matches paths if they start with `rewrite-rule/`.</span></span> <span data-ttu-id="a8608-524">В следующей таблице обратите внимание на разницу в сопоставлении.</span><span class="sxs-lookup"><span data-stu-id="a8608-524">In the following table, note the difference in matching.</span></span>

| <span data-ttu-id="a8608-525">Path</span><span class="sxs-lookup"><span data-stu-id="a8608-525">Path</span></span>                              | <span data-ttu-id="a8608-526">Соответствие</span><span class="sxs-lookup"><span data-stu-id="a8608-526">Match</span></span> |
| --------------------------------- | :---: |
| `/rewrite-rule/1234/5678`         | <span data-ttu-id="a8608-527">Да</span><span class="sxs-lookup"><span data-stu-id="a8608-527">Yes</span></span>   |
| `/my-cool-rewrite-rule/1234/5678` | <span data-ttu-id="a8608-528">Нет</span><span class="sxs-lookup"><span data-stu-id="a8608-528">No</span></span>    |
| `/anotherrewrite-rule/1234/5678`  | <span data-ttu-id="a8608-529">Нет</span><span class="sxs-lookup"><span data-stu-id="a8608-529">No</span></span>    |

<span data-ttu-id="a8608-530">После части `^rewrite-rule/` выражения стоят две группы записи `(\d+)/(\d+)`.</span><span class="sxs-lookup"><span data-stu-id="a8608-530">Following the `^rewrite-rule/` portion of the expression, there are two capture groups, `(\d+)/(\d+)`.</span></span> <span data-ttu-id="a8608-531">`\d` означает *соответствие цифре (числу)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-531">The `\d` signifies *match a digit (number)*.</span></span> <span data-ttu-id="a8608-532">Знак "плюс" (`+`) означает *соответствие одному или нескольким предшествующим символам*.</span><span class="sxs-lookup"><span data-stu-id="a8608-532">The plus sign (`+`) means *match one or more of the preceding character*.</span></span> <span data-ttu-id="a8608-533">Таким образом, URL-адрес должен содержать число, за которым идет прямая косая черта, за которой идет другое число.</span><span class="sxs-lookup"><span data-stu-id="a8608-533">Therefore, the URL must contain a number followed by a forward-slash followed by another number.</span></span> <span data-ttu-id="a8608-534">Эти группы записи внедряются в переопределенный URL-адрес как `$1` и `$2`.</span><span class="sxs-lookup"><span data-stu-id="a8608-534">These capture groups are injected into the rewritten URL as `$1` and `$2`.</span></span> <span data-ttu-id="a8608-535">Строка замены для правила переопределения помещает группы записи в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="a8608-535">The rewrite rule replacement string places the captured groups into the query string.</span></span> <span data-ttu-id="a8608-536">Запрошенный путь `/rewrite-rule/1234/5678` переопределяется, чтобы ресурс можно было получить по адресу `/rewritten?var1=1234&var2=5678`.</span><span class="sxs-lookup"><span data-stu-id="a8608-536">The requested path of `/rewrite-rule/1234/5678` is rewritten to obtain the resource at `/rewritten?var1=1234&var2=5678`.</span></span> <span data-ttu-id="a8608-537">Если в исходном запросе присутствует строка запроса, она сохраняется при переопределении URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-537">If a query string is present on the original request, it's preserved when the URL is rewritten.</span></span>

<span data-ttu-id="a8608-538">Круговое обращение к серверу для получения ресурса не выполняется.</span><span class="sxs-lookup"><span data-stu-id="a8608-538">There's no round trip to the server to obtain the resource.</span></span> <span data-ttu-id="a8608-539">Если ресурс существует, он извлекается и возвращается клиенту с кодом состояния *200 (ОК)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-539">If the resource exists, it's fetched and returned to the client with a *200 - OK* status code.</span></span> <span data-ttu-id="a8608-540">Так как клиент не перенаправляется, URL-адрес в адресной строке браузера не изменяется.</span><span class="sxs-lookup"><span data-stu-id="a8608-540">Because the client isn't redirected, the URL in the browser's address bar doesn't change.</span></span> <span data-ttu-id="a8608-541">Клиенты не могут узнать, что на сервере произошла операция переопределения URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="a8608-541">Clients can't detect that a URL rewrite operation occurred on the server.</span></span>

> [!NOTE]
> <span data-ttu-id="a8608-542">Используйте `skipRemainingRules: true` при любой возможности, так как правила сопоставления потребляют много ресурсов и ухудшают время отклика приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-542">Use `skipRemainingRules: true` whenever possible because matching rules is computationally expensive and increases app response time.</span></span> <span data-ttu-id="a8608-543">Чтобы максимально ускорить отклик приложения:</span><span class="sxs-lookup"><span data-stu-id="a8608-543">For the fastest app response:</span></span>
>
> * <span data-ttu-id="a8608-544">расположите правила переопределения в порядке от наиболее к наименее часто используемому;</span><span class="sxs-lookup"><span data-stu-id="a8608-544">Order rewrite rules from the most frequently matched rule to the least frequently matched rule.</span></span>
> * <span data-ttu-id="a8608-545">пропускайте обработку оставшихся правил, когда совпадение найдено и обработка дополнительных правил не требуется.</span><span class="sxs-lookup"><span data-stu-id="a8608-545">Skip the processing of the remaining rules when a match occurs and no additional rule processing is required.</span></span>

### <a name="apache-mod_rewrite"></a><span data-ttu-id="a8608-546">Apache mod_rewrite</span><span class="sxs-lookup"><span data-stu-id="a8608-546">Apache mod_rewrite</span></span>

<span data-ttu-id="a8608-547">Для применения правил mod_rewrite Apache можно использовать <xref:Microsoft.AspNetCore.Rewrite.ApacheModRewriteOptionsExtensions.AddApacheModRewrite*>.</span><span class="sxs-lookup"><span data-stu-id="a8608-547">Apply Apache mod_rewrite rules with <xref:Microsoft.AspNetCore.Rewrite.ApacheModRewriteOptionsExtensions.AddApacheModRewrite*>.</span></span> <span data-ttu-id="a8608-548">Убедитесь, что файл правил развертывается вместе с приложением.</span><span class="sxs-lookup"><span data-stu-id="a8608-548">Make sure that the rules file is deployed with the app.</span></span> <span data-ttu-id="a8608-549">Дополнительные сведения и примеры правил mod_rewrite см. в статье о [правилах mod_rewrite Apache](https://httpd.apache.org/docs/2.4/rewrite/).</span><span class="sxs-lookup"><span data-stu-id="a8608-549">For more information and examples of mod_rewrite rules, see [Apache mod_rewrite](https://httpd.apache.org/docs/2.4/rewrite/).</span></span>

<span data-ttu-id="a8608-550"><xref:System.IO.StreamReader> используется для чтения правил из файла *ApacheModRewrite.txt*:</span><span class="sxs-lookup"><span data-stu-id="a8608-550">A <xref:System.IO.StreamReader> is used to read the rules from the *ApacheModRewrite.txt* rules file:</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=3-4,12)]

<span data-ttu-id="a8608-551">Пример приложения перенаправляет запросы из `/apache-mod-rules-redirect/(.\*)` в `/redirected?id=$1`.</span><span class="sxs-lookup"><span data-stu-id="a8608-551">The sample app redirects requests from `/apache-mod-rules-redirect/(.\*)` to `/redirected?id=$1`.</span></span> <span data-ttu-id="a8608-552">Отклик имеет код состояния *302 (найдено)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-552">The response status code is *302 - Found*.</span></span>

[!code[](url-rewriting/samples/2.x/SampleApp/ApacheModRewrite.txt)]

<span data-ttu-id="a8608-553">Исходный запрос: `/apache-mod-rules-redirect/1234`</span><span class="sxs-lookup"><span data-stu-id="a8608-553">Original Request: `/apache-mod-rules-redirect/1234`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_apache_mod_redirect.png)

<span data-ttu-id="a8608-555">ПО промежуточного слоя поддерживает следующие переменные сервера в mod_rewrite Apache:</span><span class="sxs-lookup"><span data-stu-id="a8608-555">The middleware supports the following Apache mod_rewrite server variables:</span></span>

* <span data-ttu-id="a8608-556">CONN_REMOTE_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-556">CONN_REMOTE_ADDR</span></span>
* <span data-ttu-id="a8608-557">HTTP_ACCEPT</span><span class="sxs-lookup"><span data-stu-id="a8608-557">HTTP_ACCEPT</span></span>
* <span data-ttu-id="a8608-558">HTTP_CONNECTION</span><span class="sxs-lookup"><span data-stu-id="a8608-558">HTTP_CONNECTION</span></span>
* <span data-ttu-id="a8608-559">HTTP_COOKIE</span><span class="sxs-lookup"><span data-stu-id="a8608-559">HTTP_COOKIE</span></span>
* <span data-ttu-id="a8608-560">HTTP_FORWARDED</span><span class="sxs-lookup"><span data-stu-id="a8608-560">HTTP_FORWARDED</span></span>
* <span data-ttu-id="a8608-561">HTTP_HOST</span><span class="sxs-lookup"><span data-stu-id="a8608-561">HTTP_HOST</span></span>
* <span data-ttu-id="a8608-562">HTTP_REFERER</span><span class="sxs-lookup"><span data-stu-id="a8608-562">HTTP_REFERER</span></span>
* <span data-ttu-id="a8608-563">HTTP_USER_AGENT</span><span class="sxs-lookup"><span data-stu-id="a8608-563">HTTP_USER_AGENT</span></span>
* <span data-ttu-id="a8608-564">HTTPS</span><span class="sxs-lookup"><span data-stu-id="a8608-564">HTTPS</span></span>
* <span data-ttu-id="a8608-565">IPV6</span><span class="sxs-lookup"><span data-stu-id="a8608-565">IPV6</span></span>
* <span data-ttu-id="a8608-566">QUERY_STRING</span><span class="sxs-lookup"><span data-stu-id="a8608-566">QUERY_STRING</span></span>
* <span data-ttu-id="a8608-567">REMOTE_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-567">REMOTE_ADDR</span></span>
* <span data-ttu-id="a8608-568">REMOTE_PORT</span><span class="sxs-lookup"><span data-stu-id="a8608-568">REMOTE_PORT</span></span>
* <span data-ttu-id="a8608-569">REQUEST_FILENAME</span><span class="sxs-lookup"><span data-stu-id="a8608-569">REQUEST_FILENAME</span></span>
* <span data-ttu-id="a8608-570">REQUEST_METHOD</span><span class="sxs-lookup"><span data-stu-id="a8608-570">REQUEST_METHOD</span></span>
* <span data-ttu-id="a8608-571">REQUEST_SCHEME</span><span class="sxs-lookup"><span data-stu-id="a8608-571">REQUEST_SCHEME</span></span>
* <span data-ttu-id="a8608-572">REQUEST_URI</span><span class="sxs-lookup"><span data-stu-id="a8608-572">REQUEST_URI</span></span>
* <span data-ttu-id="a8608-573">SCRIPT_FILENAME</span><span class="sxs-lookup"><span data-stu-id="a8608-573">SCRIPT_FILENAME</span></span>
* <span data-ttu-id="a8608-574">SERVER_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-574">SERVER_ADDR</span></span>
* <span data-ttu-id="a8608-575">SERVER_PORT</span><span class="sxs-lookup"><span data-stu-id="a8608-575">SERVER_PORT</span></span>
* <span data-ttu-id="a8608-576">SERVER_PROTOCOL</span><span class="sxs-lookup"><span data-stu-id="a8608-576">SERVER_PROTOCOL</span></span>
* <span data-ttu-id="a8608-577">TIME</span><span class="sxs-lookup"><span data-stu-id="a8608-577">TIME</span></span>
* <span data-ttu-id="a8608-578">TIME_DAY</span><span class="sxs-lookup"><span data-stu-id="a8608-578">TIME_DAY</span></span>
* <span data-ttu-id="a8608-579">TIME_HOUR</span><span class="sxs-lookup"><span data-stu-id="a8608-579">TIME_HOUR</span></span>
* <span data-ttu-id="a8608-580">TIME_MIN</span><span class="sxs-lookup"><span data-stu-id="a8608-580">TIME_MIN</span></span>
* <span data-ttu-id="a8608-581">TIME_MON</span><span class="sxs-lookup"><span data-stu-id="a8608-581">TIME_MON</span></span>
* <span data-ttu-id="a8608-582">TIME_SEC</span><span class="sxs-lookup"><span data-stu-id="a8608-582">TIME_SEC</span></span>
* <span data-ttu-id="a8608-583">TIME_WDAY</span><span class="sxs-lookup"><span data-stu-id="a8608-583">TIME_WDAY</span></span>
* <span data-ttu-id="a8608-584">TIME_YEAR</span><span class="sxs-lookup"><span data-stu-id="a8608-584">TIME_YEAR</span></span>

### <a name="iis-url-rewrite-module-rules"></a><span data-ttu-id="a8608-585">Правила модуля переопределения URL-адресов для IIS</span><span class="sxs-lookup"><span data-stu-id="a8608-585">IIS URL Rewrite Module rules</span></span>

<span data-ttu-id="a8608-586">Чтобы использовать тот же набор правил, который применяется к модулю переопределения URL-адресов для IIS, используйте <xref:Microsoft.AspNetCore.Rewrite.IISUrlRewriteOptionsExtensions.AddIISUrlRewrite*>.</span><span class="sxs-lookup"><span data-stu-id="a8608-586">To use the same rule set that applies to the IIS URL Rewrite Module, use <xref:Microsoft.AspNetCore.Rewrite.IISUrlRewriteOptionsExtensions.AddIISUrlRewrite*>.</span></span> <span data-ttu-id="a8608-587">Убедитесь, что файл правил развертывается вместе с приложением.</span><span class="sxs-lookup"><span data-stu-id="a8608-587">Make sure that the rules file is deployed with the app.</span></span> <span data-ttu-id="a8608-588">Не указывайте ПО промежуточного слоя использовать файл приложения *web.config* при работе в службах IIS Windows Server.</span><span class="sxs-lookup"><span data-stu-id="a8608-588">Don't direct the middleware to use the app's *web.config* file when running on Windows Server IIS.</span></span> <span data-ttu-id="a8608-589">В IIS эти правила нужно хранить за пределами файла приложения *web.config*, чтобы предотвратить конфликты с модулем переопределения для IIS.</span><span class="sxs-lookup"><span data-stu-id="a8608-589">With IIS, these rules should be stored outside of the app's *web.config* file in order to avoid conflicts with the IIS Rewrite module.</span></span> <span data-ttu-id="a8608-590">Дополнительные сведения и примеры правил модуля переопределения URL-адресов для IIS см. в разделах [Использование модуля переопределения URL-адресов 2.0](/iis/extensions/url-rewrite-module/using-url-rewrite-module-20) и [Справочник по конфигурации модуля переопределения URL-адресов](/iis/extensions/url-rewrite-module/url-rewrite-module-configuration-reference).</span><span class="sxs-lookup"><span data-stu-id="a8608-590">For more information and examples of IIS URL Rewrite Module rules, see [Using Url Rewrite Module 2.0](/iis/extensions/url-rewrite-module/using-url-rewrite-module-20) and [URL Rewrite Module Configuration Reference](/iis/extensions/url-rewrite-module/url-rewrite-module-configuration-reference).</span></span>

<span data-ttu-id="a8608-591"><xref:System.IO.StreamReader> используется для чтения правил из файла *IISUrlRewrite.xml*:</span><span class="sxs-lookup"><span data-stu-id="a8608-591">A <xref:System.IO.StreamReader> is used to read the rules from the *IISUrlRewrite.xml* rules file:</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=5-6,13)]

<span data-ttu-id="a8608-592">Пример приложения переопределяет запросы с `/iis-rules-rewrite/(.*)` на `/rewritten?id=$1`.</span><span class="sxs-lookup"><span data-stu-id="a8608-592">The sample app rewrites requests from `/iis-rules-rewrite/(.*)` to `/rewritten?id=$1`.</span></span> <span data-ttu-id="a8608-593">Клиенту отправляется отклик с кодом состояния *200 (ОК)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-593">The response is sent to the client with a *200 - OK* status code.</span></span>

[!code-xml[](url-rewriting/samples/2.x/SampleApp/IISUrlRewrite.xml)]

<span data-ttu-id="a8608-594">Исходный запрос: `/iis-rules-rewrite/1234`</span><span class="sxs-lookup"><span data-stu-id="a8608-594">Original Request: `/iis-rules-rewrite/1234`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запрос и отклик](url-rewriting/_static/add_iis_url_rewrite.png)

<span data-ttu-id="a8608-596">Если имеется активный модуль переопределения для IIS, где настроены правила брандмауэра уровня сервера, способные негативно повлиять на ваше приложение, можно отключить этот модуль для приложения.</span><span class="sxs-lookup"><span data-stu-id="a8608-596">If you have an active IIS Rewrite Module with server-level rules configured that would impact your app in undesirable ways, you can disable the IIS Rewrite Module for an app.</span></span> <span data-ttu-id="a8608-597">Дополнительные сведения см. в разделе [Отключение модулей IIS](xref:host-and-deploy/iis/modules#disabling-iis-modules).</span><span class="sxs-lookup"><span data-stu-id="a8608-597">For more information, see [Disabling IIS modules](xref:host-and-deploy/iis/modules#disabling-iis-modules).</span></span>

#### <a name="unsupported-features"></a><span data-ttu-id="a8608-598">Неподдерживаемые функции</span><span class="sxs-lookup"><span data-stu-id="a8608-598">Unsupported features</span></span>

<span data-ttu-id="a8608-599">ПО промежуточного слоя, выпущенное вместе с ASP.NET Core 2.x, не поддерживает следующие функции в модуле переопределения URL-адресов для IIS:</span><span class="sxs-lookup"><span data-stu-id="a8608-599">The middleware released with ASP.NET Core 2.x doesn't support the following IIS URL Rewrite Module features:</span></span>

* <span data-ttu-id="a8608-600">Правила для исходящих подключений</span><span class="sxs-lookup"><span data-stu-id="a8608-600">Outbound Rules</span></span>
* <span data-ttu-id="a8608-601">Пользовательские переменные сервера</span><span class="sxs-lookup"><span data-stu-id="a8608-601">Custom Server Variables</span></span>
* <span data-ttu-id="a8608-602">Знаки подстановки</span><span class="sxs-lookup"><span data-stu-id="a8608-602">Wildcards</span></span>
* <span data-ttu-id="a8608-603">LogRewrittenUrl</span><span class="sxs-lookup"><span data-stu-id="a8608-603">LogRewrittenUrl</span></span>

#### <a name="supported-server-variables"></a><span data-ttu-id="a8608-604">Поддерживаемые переменные сервера</span><span class="sxs-lookup"><span data-stu-id="a8608-604">Supported server variables</span></span>

<span data-ttu-id="a8608-605">ПО промежуточного слоя поддерживает следующие переменные сервера в модуле переопределения URL-адресов для IIS:</span><span class="sxs-lookup"><span data-stu-id="a8608-605">The middleware supports the following IIS URL Rewrite Module server variables:</span></span>

* <span data-ttu-id="a8608-606">CONTENT_LENGTH</span><span class="sxs-lookup"><span data-stu-id="a8608-606">CONTENT_LENGTH</span></span>
* <span data-ttu-id="a8608-607">CONTENT_TYPE</span><span class="sxs-lookup"><span data-stu-id="a8608-607">CONTENT_TYPE</span></span>
* <span data-ttu-id="a8608-608">HTTP_ACCEPT</span><span class="sxs-lookup"><span data-stu-id="a8608-608">HTTP_ACCEPT</span></span>
* <span data-ttu-id="a8608-609">HTTP_CONNECTION</span><span class="sxs-lookup"><span data-stu-id="a8608-609">HTTP_CONNECTION</span></span>
* <span data-ttu-id="a8608-610">HTTP_COOKIE</span><span class="sxs-lookup"><span data-stu-id="a8608-610">HTTP_COOKIE</span></span>
* <span data-ttu-id="a8608-611">HTTP_HOST</span><span class="sxs-lookup"><span data-stu-id="a8608-611">HTTP_HOST</span></span>
* <span data-ttu-id="a8608-612">HTTP_REFERER</span><span class="sxs-lookup"><span data-stu-id="a8608-612">HTTP_REFERER</span></span>
* <span data-ttu-id="a8608-613">HTTP_URL</span><span class="sxs-lookup"><span data-stu-id="a8608-613">HTTP_URL</span></span>
* <span data-ttu-id="a8608-614">HTTP_USER_AGENT</span><span class="sxs-lookup"><span data-stu-id="a8608-614">HTTP_USER_AGENT</span></span>
* <span data-ttu-id="a8608-615">HTTPS</span><span class="sxs-lookup"><span data-stu-id="a8608-615">HTTPS</span></span>
* <span data-ttu-id="a8608-616">LOCAL_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-616">LOCAL_ADDR</span></span>
* <span data-ttu-id="a8608-617">QUERY_STRING</span><span class="sxs-lookup"><span data-stu-id="a8608-617">QUERY_STRING</span></span>
* <span data-ttu-id="a8608-618">REMOTE_ADDR</span><span class="sxs-lookup"><span data-stu-id="a8608-618">REMOTE_ADDR</span></span>
* <span data-ttu-id="a8608-619">REMOTE_PORT</span><span class="sxs-lookup"><span data-stu-id="a8608-619">REMOTE_PORT</span></span>
* <span data-ttu-id="a8608-620">REQUEST_FILENAME</span><span class="sxs-lookup"><span data-stu-id="a8608-620">REQUEST_FILENAME</span></span>
* <span data-ttu-id="a8608-621">REQUEST_URI</span><span class="sxs-lookup"><span data-stu-id="a8608-621">REQUEST_URI</span></span>

> [!NOTE]
> <span data-ttu-id="a8608-622">Можно также получить <xref:Microsoft.Extensions.FileProviders.IFileProvider> через <xref:Microsoft.Extensions.FileProviders.PhysicalFileProvider>.</span><span class="sxs-lookup"><span data-stu-id="a8608-622">You can also obtain an <xref:Microsoft.Extensions.FileProviders.IFileProvider> via a <xref:Microsoft.Extensions.FileProviders.PhysicalFileProvider>.</span></span> <span data-ttu-id="a8608-623">Такой подход позволяет более гибко задавать расположение для файлов с правилами переопределения.</span><span class="sxs-lookup"><span data-stu-id="a8608-623">This approach may provide greater flexibility for the location of your rewrite rules files.</span></span> <span data-ttu-id="a8608-624">Убедитесь, что эти файлы развертываются на сервере по указанному пути.</span><span class="sxs-lookup"><span data-stu-id="a8608-624">Make sure that your rewrite rules files are deployed to the server at the path you provide.</span></span>
>
> ```csharp
> PhysicalFileProvider fileProvider = new PhysicalFileProvider(Directory.GetCurrentDirectory());
> ```

### <a name="method-based-rule"></a><span data-ttu-id="a8608-625">Правило, основанное на методе</span><span class="sxs-lookup"><span data-stu-id="a8608-625">Method-based rule</span></span>

<span data-ttu-id="a8608-626">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*>, чтобы реализовать собственную логику правил в методе.</span><span class="sxs-lookup"><span data-stu-id="a8608-626">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*> to implement your own rule logic in a method.</span></span> <span data-ttu-id="a8608-627">`Add` предоставляет <xref:Microsoft.AspNetCore.Rewrite.RewriteContext>, который предоставляет <xref:Microsoft.AspNetCore.Http.HttpContext> для использования в методе.</span><span class="sxs-lookup"><span data-stu-id="a8608-627">`Add` exposes the <xref:Microsoft.AspNetCore.Rewrite.RewriteContext>, which makes available the <xref:Microsoft.AspNetCore.Http.HttpContext> for use in your method.</span></span> <span data-ttu-id="a8608-628">[RewriteContext.Result](xref:Microsoft.AspNetCore.Rewrite.RewriteContext.Result*) определяет, как осуществляется дополнительная обработка в конвейере.</span><span class="sxs-lookup"><span data-stu-id="a8608-628">The [RewriteContext.Result](xref:Microsoft.AspNetCore.Rewrite.RewriteContext.Result*) determines how additional pipeline processing is handled.</span></span> <span data-ttu-id="a8608-629">Установите значение одного из полей <xref:Microsoft.AspNetCore.Rewrite.RuleResult> из следующей таблицы.</span><span class="sxs-lookup"><span data-stu-id="a8608-629">Set the value to one of the <xref:Microsoft.AspNetCore.Rewrite.RuleResult> fields described in the following table.</span></span>

| <span data-ttu-id="a8608-630">Результат перезаписи контекста</span><span class="sxs-lookup"><span data-stu-id="a8608-630">Rewrite context result</span></span>               | <span data-ttu-id="a8608-631">Действие</span><span class="sxs-lookup"><span data-stu-id="a8608-631">Action</span></span>                                                           |
| ------------------------------------ | ---------------------------------------------------------------- |
| <span data-ttu-id="a8608-632">`RuleResult.ContinueRules` (по умолчанию)</span><span class="sxs-lookup"><span data-stu-id="a8608-632">`RuleResult.ContinueRules` (default)</span></span> | <span data-ttu-id="a8608-633">Продолжение применения правил.</span><span class="sxs-lookup"><span data-stu-id="a8608-633">Continue applying rules.</span></span>                                         |
| `RuleResult.EndResponse`             | <span data-ttu-id="a8608-634">Остановка применения правил и отправка отклика.</span><span class="sxs-lookup"><span data-stu-id="a8608-634">Stop applying rules and send the response.</span></span>                       |
| `RuleResult.SkipRemainingRules`      | <span data-ttu-id="a8608-635">Остановка применения правил и отправка контекста в следующий компонент ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="a8608-635">Stop applying rules and send the context to the next middleware.</span></span> |

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=14)]

<span data-ttu-id="a8608-636">Пример приложения демонстрирует метод, который перенаправляет запросы для путей, заканчивающихся на *.xml*.</span><span class="sxs-lookup"><span data-stu-id="a8608-636">The sample app demonstrates a method that redirects requests for paths that end with *.xml*.</span></span> <span data-ttu-id="a8608-637">Если запрос выполняется для `/file.xml`, запрос перенаправляется к `/xmlfiles/file.xml`.</span><span class="sxs-lookup"><span data-stu-id="a8608-637">If a request is made for `/file.xml`, the request is redirected to `/xmlfiles/file.xml`.</span></span> <span data-ttu-id="a8608-638">Для кода состояния задается значение *301 (перемещен окончательно)* .</span><span class="sxs-lookup"><span data-stu-id="a8608-638">The status code is set to *301 - Moved Permanently*.</span></span> <span data-ttu-id="a8608-639">Когда браузер отправляет новый запрос на */xmlfiles/file.xml*, ПО промежуточного слоя статических файлов предоставляет файл клиенту из папки *wwwroot/xmlfiles*.</span><span class="sxs-lookup"><span data-stu-id="a8608-639">When the browser makes a new request for */xmlfiles/file.xml*, Static File Middleware serves the file to the client from the *wwwroot/xmlfiles* folder.</span></span> <span data-ttu-id="a8608-640">Для перенаправления необходимо явно указать код состояния ответа.</span><span class="sxs-lookup"><span data-stu-id="a8608-640">For a redirect, explicitly set the status code of the response.</span></span> <span data-ttu-id="a8608-641">В противном случае возвращается код состояния *200 (ОК)* и перенаправление на стороне клиента не происходит.</span><span class="sxs-lookup"><span data-stu-id="a8608-641">Otherwise, a *200 - OK* status code is returned, and the redirect doesn't occur on the client.</span></span>

<span data-ttu-id="a8608-642">*RewriteRules.cs*:</span><span class="sxs-lookup"><span data-stu-id="a8608-642">*RewriteRules.cs*:</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/RewriteRules.cs?name=snippet_RedirectXmlFileRequests&highlight=14-18)]

<span data-ttu-id="a8608-643">Этот подход также переопределяет запросы.</span><span class="sxs-lookup"><span data-stu-id="a8608-643">This approach can also rewrite requests.</span></span> <span data-ttu-id="a8608-644">В примере приложения показано переопределение пути для любого запроса текстового файла, чтобы отправить текстовый файл *file.txt* из папки *wwwroot*.</span><span class="sxs-lookup"><span data-stu-id="a8608-644">The sample app demonstrates rewriting the path for any text file request to serve the *file.txt* text file from the *wwwroot* folder.</span></span> <span data-ttu-id="a8608-645">ПО промежуточного слоя статических файлов предоставляет файл по обновленному пути запроса:</span><span class="sxs-lookup"><span data-stu-id="a8608-645">Static File Middleware serves the file based on the updated request path:</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=15,22)]

<span data-ttu-id="a8608-646">*RewriteRules.cs*:</span><span class="sxs-lookup"><span data-stu-id="a8608-646">*RewriteRules.cs*:</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/RewriteRules.cs?name=snippet_RewriteTextFileRequests&highlight=7-8)]

### <a name="irule-based-rule"></a><span data-ttu-id="a8608-647">Правило, основанное на IRule</span><span class="sxs-lookup"><span data-stu-id="a8608-647">IRule-based rule</span></span>

<span data-ttu-id="a8608-648">Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*>, чтобы использовать собственную логику правил в классе, реализующем интерфейс <xref:Microsoft.AspNetCore.Rewrite.IRule>.</span><span class="sxs-lookup"><span data-stu-id="a8608-648">Use <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*> to use rule logic in a class that implements the <xref:Microsoft.AspNetCore.Rewrite.IRule> interface.</span></span> <span data-ttu-id="a8608-649">`IRule` позволяет более гибко применять правила, основанные на методах.</span><span class="sxs-lookup"><span data-stu-id="a8608-649">`IRule` provides greater flexibility over using the method-based rule approach.</span></span> <span data-ttu-id="a8608-650">Класс реализации может включать конструктор, который позволяет передавать параметры для метода <xref:Microsoft.AspNetCore.Rewrite.IRule.ApplyRule*>.</span><span class="sxs-lookup"><span data-stu-id="a8608-650">Your implementation class may include a constructor that allows you can pass in parameters for the <xref:Microsoft.AspNetCore.Rewrite.IRule.ApplyRule*> method.</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=16-17)]

<span data-ttu-id="a8608-651">Значения параметров в примере приложения для `extension` и `newPath` проверяются на соответствие нескольким условиям.</span><span class="sxs-lookup"><span data-stu-id="a8608-651">The values of the parameters in the sample app for the `extension` and the `newPath` are checked to meet several conditions.</span></span> <span data-ttu-id="a8608-652">`extension` должен содержать одно из значений: *.png*, *.jpg* или *.gif*.</span><span class="sxs-lookup"><span data-stu-id="a8608-652">The `extension` must contain a value, and the value must be *.png*, *.jpg*, or *.gif*.</span></span> <span data-ttu-id="a8608-653">Если `newPath` не является допустимым, возникает исключение <xref:System.ArgumentException>.</span><span class="sxs-lookup"><span data-stu-id="a8608-653">If the `newPath` isn't valid, an <xref:System.ArgumentException> is thrown.</span></span> <span data-ttu-id="a8608-654">Если запрос выполняется для *image.png*, запрос перенаправляется к `/png-images/image.png`.</span><span class="sxs-lookup"><span data-stu-id="a8608-654">If a request is made for *image.png*, the request is redirected to `/png-images/image.png`.</span></span> <span data-ttu-id="a8608-655">Если запрос выполняется для *image.jpg*, запрос перенаправляется к `/jpg-images/image.jpg`.</span><span class="sxs-lookup"><span data-stu-id="a8608-655">If a request is made for *image.jpg*, the request is redirected to `/jpg-images/image.jpg`.</span></span> <span data-ttu-id="a8608-656">Для кода состояния устанавливается значение *301 (перемещен окончательно)* , а также задается `context.Result`, чтобы остановить обработку правил и отправить отклик.</span><span class="sxs-lookup"><span data-stu-id="a8608-656">The status code is set to *301 - Moved Permanently*, and the `context.Result` is set to stop processing rules and send the response.</span></span>

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/RewriteRules.cs?name=snippet_RedirectImageRequests)]

<span data-ttu-id="a8608-657">Исходный запрос: `/image.png`</span><span class="sxs-lookup"><span data-stu-id="a8608-657">Original Request: `/image.png`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики для image.png](url-rewriting/_static/add_redirect_png_requests.png)

<span data-ttu-id="a8608-659">Исходный запрос: `/image.jpg`</span><span class="sxs-lookup"><span data-stu-id="a8608-659">Original Request: `/image.jpg`</span></span>

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики для image.jpg](url-rewriting/_static/add_redirect_jpg_requests.png)

## <a name="regex-examples"></a><span data-ttu-id="a8608-661">Примеры регулярных выражений</span><span class="sxs-lookup"><span data-stu-id="a8608-661">Regex examples</span></span>

| <span data-ttu-id="a8608-662">Goal</span><span class="sxs-lookup"><span data-stu-id="a8608-662">Goal</span></span> | <span data-ttu-id="a8608-663">Пример строки регулярного выражения</span><span class="sxs-lookup"><span data-stu-id="a8608-663">Regex String &</span></span><br><span data-ttu-id="a8608-664">и совпадения</span><span class="sxs-lookup"><span data-stu-id="a8608-664">Match Example</span></span> | <span data-ttu-id="a8608-665">Пример строки замены и</span><span class="sxs-lookup"><span data-stu-id="a8608-665">Replacement String &</span></span><br><span data-ttu-id="a8608-666">выходных данных</span><span class="sxs-lookup"><span data-stu-id="a8608-666">Output Example</span></span> |
| ---- | ------------------------------- | -------------------------------------- |
| <span data-ttu-id="a8608-667">Переопределение пути в строке запроса</span><span class="sxs-lookup"><span data-stu-id="a8608-667">Rewrite path into querystring</span></span> | `^path/(.*)/(.*)`<br>`/path/abc/123` | `path?var1=$1&var2=$2`<br>`/path?var1=abc&var2=123` |
| <span data-ttu-id="a8608-668">Удаление косой черты в конце</span><span class="sxs-lookup"><span data-stu-id="a8608-668">Strip trailing slash</span></span> | `(.*)/$`<br>`/path/` | `$1`<br>`/path` |
| <span data-ttu-id="a8608-669">Добавление косой черты в конце</span><span class="sxs-lookup"><span data-stu-id="a8608-669">Enforce trailing slash</span></span> | `(.*[^/])$`<br>`/path` | `$1/`<br>`/path/` |
| <span data-ttu-id="a8608-670">Запрет переопределения отдельных запросов</span><span class="sxs-lookup"><span data-stu-id="a8608-670">Avoid rewriting specific requests</span></span> | <span data-ttu-id="a8608-671">`^(.*)(?<!\.axd)$` или `^(?!.*\.axd$)(.*)$`</span><span class="sxs-lookup"><span data-stu-id="a8608-671">`^(.*)(?<!\.axd)$` or `^(?!.*\.axd$)(.*)$`</span></span><br><span data-ttu-id="a8608-672">Да: `/resource.htm`</span><span class="sxs-lookup"><span data-stu-id="a8608-672">Yes: `/resource.htm`</span></span><br><span data-ttu-id="a8608-673">Нет: `/resource.axd`</span><span class="sxs-lookup"><span data-stu-id="a8608-673">No: `/resource.axd`</span></span> | `rewritten/$1`<br>`/rewritten/resource.htm`<br>`/resource.axd` |
| <span data-ttu-id="a8608-674">Переупорядочение сегментов URL-адреса</span><span class="sxs-lookup"><span data-stu-id="a8608-674">Rearrange URL segments</span></span> | `path/(.*)/(.*)/(.*)`<br>`path/1/2/3` | `path/$3/$2/$1`<br>`path/3/2/1` |
| <span data-ttu-id="a8608-675">Замена сегмента URL-адреса</span><span class="sxs-lookup"><span data-stu-id="a8608-675">Replace a URL segment</span></span> | `^(.*)/segment2/(.*)`<br>`/segment1/segment2/segment3` | `$1/replaced/$2`<br>`/segment1/replaced/segment3` |

::: moniker-end

## <a name="additional-resources"></a><span data-ttu-id="a8608-676">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="a8608-676">Additional resources</span></span>

* <xref:fundamentals/startup>
* <xref:fundamentals/middleware/index>
* [<span data-ttu-id="a8608-677">Регулярные выражения в .NET</span><span class="sxs-lookup"><span data-stu-id="a8608-677">Regular expressions in .NET</span></span>](/dotnet/articles/standard/base-types/regular-expressions)
* [<span data-ttu-id="a8608-678">Элементы языка регулярных выражений — краткий справочник</span><span class="sxs-lookup"><span data-stu-id="a8608-678">Regular expression language - quick reference</span></span>](/dotnet/articles/standard/base-types/quick-ref)
* [<span data-ttu-id="a8608-679">Apache mod_rewrite</span><span class="sxs-lookup"><span data-stu-id="a8608-679">Apache mod_rewrite</span></span>](https://httpd.apache.org/docs/2.4/rewrite/)
* [<span data-ttu-id="a8608-680">Использование модуля переопределения URL-адресов 2.0 (для IIS)</span><span class="sxs-lookup"><span data-stu-id="a8608-680">Using Url Rewrite Module 2.0 (for IIS)</span></span>](/iis/extensions/url-rewrite-module/using-url-rewrite-module-20)
* [<span data-ttu-id="a8608-681">Справочник по конфигурации модуля переопределения URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-681">URL Rewrite Module Configuration Reference</span></span>](/iis/extensions/url-rewrite-module/url-rewrite-module-configuration-reference)
* [<span data-ttu-id="a8608-682">Форум по модулю переопределения URL-адресов для IIS</span><span class="sxs-lookup"><span data-stu-id="a8608-682">IIS URL Rewrite Module Forum</span></span>](https://forums.iis.net/1152.aspx)
* [<span data-ttu-id="a8608-683">Сохранение простой структуры URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-683">Keep a simple URL structure</span></span>](https://support.google.com/webmasters/answer/76329?hl=en)
* [<span data-ttu-id="a8608-684">10 советов по переопределению URL-адресов</span><span class="sxs-lookup"><span data-stu-id="a8608-684">10 URL Rewriting Tips and Tricks</span></span>](https://ruslany.net/2009/04/10-url-rewriting-tips-and-tricks/)
* [<span data-ttu-id="a8608-685">Аспекты использования косой черты</span><span class="sxs-lookup"><span data-stu-id="a8608-685">To slash or not to slash</span></span>](https://webmasters.googleblog.com/2010/04/to-slash-or-not-to-slash.html)
